# Terraform configuration for external IAM pattern
# Generated by tf_deploy.py

# IAM Stack - deployed first
resource "aws_cloudformation_stack" "iam" {
  name = "${var.name}-iam"

  template_url = var.iam_template_url

  capabilities = ["CAPABILITY_IAM", "CAPABILITY_NAMED_IAM"]

  tags = {
    Name        = "${var.name}-iam"
    Component   = "IAM"
    Environment = "{{ config.environment }}"
  }
}

# Application Stack - depends on IAM stack
resource "aws_cloudformation_stack" "app" {
  name = var.name

  template_url = var.template_url

  depends_on = [aws_cloudformation_stack.iam]

  capabilities = ["CAPABILITY_IAM", "CAPABILITY_NAMED_IAM"]

  parameters = merge(
    {
      # Network parameters
      VPC            = var.vpc_id
      PublicSubnets  = join(",", var.subnet_ids)
      Subnets        = join(",", var.subnet_ids)

      # DNS/TLS parameters
      CertificateArnELB = var.certificate_arn
      QuiltWebHost      = var.quilt_web_host

      # Admin parameters
      AdminEmail = var.admin_email

      # Database parameters
      DBInstanceClass = var.db_instance_class

      # Search parameters
      SearchInstanceType = var.search_instance_type
      SearchVolumeSize   = var.search_volume_size
    },
    # IAM role/policy parameters from IAM stack outputs
    {
      for key, value in aws_cloudformation_stack.iam.outputs :
      key => value
    }
  )

  tags = {
    Name        = var.name
    Component   = "Application"
    Environment = "{{ config.environment }}"
  }
}

# Outputs
output "iam_stack_name" {
  description = "IAM stack name"
  value       = aws_cloudformation_stack.iam.name
}

output "iam_stack_id" {
  description = "IAM stack ID"
  value       = aws_cloudformation_stack.iam.id
}

output "app_stack_name" {
  description = "Application stack name"
  value       = aws_cloudformation_stack.app.name
}

output "app_stack_id" {
  description = "Application stack ID"
  value       = aws_cloudformation_stack.app.id
}

output "quilt_url" {
  description = "Quilt application URL"
  value       = "https://${var.quilt_web_host}"
}

output "iam_outputs" {
  description = "IAM stack outputs (all role/policy ARNs)"
  value       = aws_cloudformation_stack.iam.outputs
  sensitive   = false
}
