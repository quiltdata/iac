AWSTemplateFormatVersion: '2010-09-09'
Description: IAM roles and policies for Quilt Data infrastructure
Resources:
  BucketReadPolicy:
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: s3:*
            NotResource: '*'
    Type: AWS::IAM::ManagedPolicy
  BucketWritePolicy:
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: s3:*
            NotResource: '*'
    Type: AWS::IAM::ManagedPolicy
  RegistryAssumeRolePolicy:
    Properties:
      Path: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
      Description: Allow registry assume custom user roles
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action: sts:AssumeRole
          NotResource: '*'
    Type: AWS::IAM::ManagedPolicy
  T4BucketReadRole:
    Properties:
      RoleName: !Sub 'ReadQuiltV2-${AWS::StackName}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              AWS:
                - !GetAtt 'AmazonECSTaskExecutionRole.Arn'
                - arn:aws:iam::712023778557:user/kevin-staging
                - arn:aws:iam::712023778557:user/ernest-staging
                - arn:aws:iam::712023778557:user/nl0-staging
                - arn:aws:iam::712023778557:user/sergey
                - arn:aws:iam::712023778557:user/fiskus-staging
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - !Ref 'T4DefaultBucketReadPolicy'
        - !Ref 'BucketReadPolicy'
        - !Ref 'UserAthenaNonManagedRolePolicy'
    Type: AWS::IAM::Role
  ManagedUserRole:
    Properties:
      Path: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              AWS:
                - !GetAtt 'AmazonECSTaskExecutionRole.Arn'
                - arn:aws:iam::712023778557:user/kevin-staging
                - arn:aws:iam::712023778557:user/ernest-staging
                - arn:aws:iam::712023778557:user/nl0-staging
                - arn:aws:iam::712023778557:user/sergey
                - arn:aws:iam::712023778557:user/fiskus-staging
            Action:
              - sts:AssumeRole
      ManagedPolicyArns: !Split
        - ','
        - !Sub
            - ${base_policies}${extra_policies}
            - base_policies: !Join
                - ','
                -   - !Ref 'ManagedUserRoleBasePolicy'
                    - !Ref 'BucketReadPolicy'
                    - !Ref 'BucketWritePolicy'
                    - !Ref 'UserAthenaManagedRolePolicy'
              extra_policies: !If
                - ManagedUserRoleExtraPoliciesEmpty
                - ''
                - !Sub ',${ManagedUserRoleExtraPolicies}'
    Type: AWS::IAM::Role
  S3ProxyRole:
    Properties:
      Path: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: AllowGetELBCertificate
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: acm:GetCertificate
                Resource: !Ref 'CertificateArnELB'
    Type: AWS::IAM::Role
  ApiRole:
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole'
    Type: AWS::IAM::Role
  TimestampResourceHandlerRole:
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole'
    Type: AWS::IAM::Role
  TabulatorOpenQueryRole:
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              AWS:
                - !Sub '${AmazonECSTaskExecutionRole.Arn}'
            Action:
              - sts:AssumeRole
      Path: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
      ManagedPolicyArns:
        - !Ref 'BucketReadPolicy'
        - !Ref 'UserAthenaManagedRolePolicy'
    Type: AWS::IAM::Role
Outputs:
  BucketReadPolicyArn:
    Description: ARN of BucketReadPolicy
    Value:
      Ref: BucketReadPolicy
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-BucketReadPolicyArn
  BucketWritePolicyArn:
    Description: ARN of BucketWritePolicy
    Value:
      Ref: BucketWritePolicy
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-BucketWritePolicyArn
  RegistryAssumeRolePolicyArn:
    Description: ARN of RegistryAssumeRolePolicy
    Value:
      Ref: RegistryAssumeRolePolicy
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-RegistryAssumeRolePolicyArn
  T4BucketReadRoleArn:
    Description: ARN of T4BucketReadRole
    Value:
      Fn::GetAtt:
        - T4BucketReadRole
        - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-T4BucketReadRoleArn
  ManagedUserRoleArn:
    Description: ARN of ManagedUserRole
    Value:
      Fn::GetAtt:
        - ManagedUserRole
        - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ManagedUserRoleArn
  S3ProxyRoleArn:
    Description: ARN of S3ProxyRole
    Value:
      Fn::GetAtt:
        - S3ProxyRole
        - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-S3ProxyRoleArn
  ApiRoleArn:
    Description: ARN of ApiRole
    Value:
      Fn::GetAtt:
        - ApiRole
        - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiRoleArn
  TimestampResourceHandlerRoleArn:
    Description: ARN of TimestampResourceHandlerRole
    Value:
      Fn::GetAtt:
        - TimestampResourceHandlerRole
        - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-TimestampResourceHandlerRoleArn
  TabulatorOpenQueryRoleArn:
    Description: ARN of TabulatorOpenQueryRole
    Value:
      Fn::GetAtt:
        - TabulatorOpenQueryRole
        - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-TabulatorOpenQueryRoleArn
