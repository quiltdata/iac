Description: (c) 2025 Quilt Data, Inc. - Private Quilt catalog and services
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Administrator catalog credentials
        Parameters:
          - AdminEmail
          - AdminPassword
      - Label:
          default: Web catalog
        Parameters:
          - CertificateArnELB
          - QuiltWebHost
          - WAFGeofenceCountries
          - WAFRequestRateLimit
      - Label:
          default: Database
        Parameters:
          - DBUrl
          - DBAccessorSecurityGroup
      - Label:
          default: Network settings
        Parameters:
          - VPC
          - Subnets
          - UserSecurityGroup
          - PublicSubnets
      - Label:
          default: Analytics
        Parameters:
          - CloudTrailBucket
      - Label:
          default: Web catalog authentication
        Parameters:
          - PasswordAuth
          - GoogleAuth
          - GoogleClientId
          - GoogleClientSecret
          - SingleSignOnDomains
          - OktaAuth
          - OktaClientId
          - OktaClientSecret
          - OktaBaseUrl
          - OneLoginAuth
          - OneLoginClientId
          - OneLoginClientSecret
          - OneLoginBaseUrl
          - AzureAuth
          - AzureClientId
          - AzureClientSecret
          - AzureBaseUrl
      - Label:
          default: Beta features
        Parameters:
          - ChunkedChecksums
          - Qurator
      - Label:
          default: IAM roles and policies
        Parameters:
          - AccessCountsRole
          - AmazonECSTaskExecutionRole
          - ApiRole
          - BucketReadPolicy
          - BucketWritePolicy
          - DuckDBSelectLambdaRole
          - EsIngestRole
          - IcebergLambdaRole
          - ManagedUserRole
          - ManagedUserRoleBasePolicy
          - ManifestIndexerRole
          - MigrationLambdaRole
          - PackagerRole
          - PkgEventsRole
          - PkgPushRole
          - RegistryAssumeRolePolicy
          - S3CopyLambdaRole
          - S3HashLambdaRole
          - S3ProxyRole
          - S3SNSToEventBridgeRole
          - SearchHandlerRole
          - T4BucketReadRole
          - T4BucketWriteRole
          - T4DefaultBucketReadPolicy
          - TabulatorOpenQueryPolicy
          - TabulatorOpenQueryRole
          - TabulatorRole
          - TimestampResourceHandlerRole
          - TrackingCronRole
          - UserAthenaManagedRolePolicy
          - UserAthenaNonManagedRolePolicy
      - Label:
          default: GxP qualification
        Parameters:
          - CanaryNotificationsEmail
Conditions:
  ChunkedChecksumsEnabled:
    - !Ref 'ChunkedChecksums'
    - Enabled
  QuratorEnabled:
    - !Ref 'Qurator'
    - Enabled
  S3BucketPolicyExcludeArnsFromDenyEmpty:
    -   - ','
        - !Ref 'S3BucketPolicyExcludeArnsFromDeny'
    - ''
  SingleSignOn:
    -   - !Ref 'PasswordAuth'
        - Enabled
  SsoAuth:
    -   - !Ref 'GoogleAuth'
        - Enabled
    -   - !Ref 'OktaAuth'
        - Enabled
    -   - !Ref 'OneLoginAuth'
        - Enabled
    -   - !Ref 'AzureAuth'
        - Enabled
  GoogleAuth:
    - !Ref 'GoogleAuth'
    - Enabled
  OktaAuth:
    - !Ref 'OktaAuth'
    - Enabled
  OneLoginAuth:
    - !Ref 'OneLoginAuth'
    - Enabled
  AzureAuth:
    - !Ref 'AzureAuth'
    - Enabled
  IsWAFGeofenceCountriesEmpty:
    - !Ref 'WAFGeofenceCountries'
    - '*'
  GovCloud:
    - !Ref 'AWS::Partition'
    - aws-us-gov
  UserAthenaBytesScannedCutoffDisabled:
    - !Ref 'UserAthenaBytesScannedCutoff'
    - 0
  ManagedUserRoleExtraPoliciesEmpty:
    - !Ref 'ManagedUserRoleExtraPolicies'
    - ''
Mappings:
  PartitionConfig:
    aws:
      PrimaryRegion: us-east-1
      AccountId: '730278974607'
      ApiGatewayType: EDGE
    aws-us-gov:
      PrimaryRegion: us-gov-east-1
      AccountId: '313325871032'
      ApiGatewayType: REGIONAL
  VoilaImage:
    '0.2.10':
      Tag: d5da4d225fdf2ae5354d7ea7ae997a0611f89bb8
    '0.5.8':
      Tag: 2ef2055804d0cb749dc4a153b2cc28b4cbc6412b
Outputs:
  OutboundSecurityGroup:
    Description: Security group used for any outbound connections.
    Value: !Ref 'OutboundSecurityGroup'
    Export:
      Name: !Sub '${AWS::StackName}-OutboundSecurityGroup'
  LoadBalancerDNSName:
    Description: Load balancer for Quilt server
    Value: !GetAtt 'LoadBalancer.DNSName'
    Export:
      Name: !Sub '${AWS::StackName}-LoadBalancerDNSName'
  LoadBalancerCanonicalHostedZoneID:
    Description: The ID of the Amazon Route 53 hosted zone associated with the load balancer.
    Value: !GetAtt 'LoadBalancer.CanonicalHostedZoneID'
    Export:
      Name: !Sub '${AWS::StackName}-LoadBalancerCanonicalHostedZoneID'
  UserAthenaDatabaseName:
    Description: Name of Athena database with tables/views for package manifests.
    Value: !Ref 'UserAthenaDatabase'
  EventBusArn:
    Description: ARN of the event bus for the stack.
    Value: !GetAtt 'EventBus.Arn'
    Export:
      Name: !Sub '${AWS::StackName}-EventBusArn'
  PackagerQueueArn:
    Value: !GetAtt 'PackagerQueue.Arn'
    Export:
      Name: !Sub '${AWS::StackName}-PackagerQueueArn'
  PackagerQueueUrl:
    Value: !GetAtt 'PackagerQueue.QueueUrl'
    Export:
      Name: !Sub '${AWS::StackName}-PackagerQueueUrl'
  RegistryRoleARN:
    Description: ARN of execution role used for identity service. Use this to set up a trust relationship.
    Value: !Ref 'AmazonECSTaskExecutionRole'
  RegistryHost:
    Description: Hostname of the Quilt server. Create a CNAME record for <RegistryHostName> with value <LoadBalancerDNSName>.
    Value:
      - .
      -   -   - '-'
              -   -   - 0
                      -   - .
                          - !Ref 'QuiltWebHost'
                  - registry
          -   - 1
              -   - .
                  - !Ref 'QuiltWebHost'
          -   - 2
              -   - .
                  - !Ref 'QuiltWebHost'
  S3ProxyHost:
    Description: Hostname of the S3 proxy. Create a CNAME record for <S3ProxyHostName> with value <LoadBalancerDNSName>.
    Value:
      - .
      -   -   - '-'
              -   -   - 0
                      -   - .
                          - !Ref 'QuiltWebHost'
                  - s3-proxy
          -   - 1
              -   - .
                  - !Ref 'QuiltWebHost'
          -   - 2
              -   - .
                  - !Ref 'QuiltWebHost'
  QuiltWebHost:
    Description: Hostname for your Quilt catalog. Create a CNAME record for <QuiltWebHost> with value <LoadBalancerDNSName>.
    Value: !Ref 'QuiltWebHost'
  TemplateBuildMetadata:
    Description: Metadata generated by the Quilt build system.
    Value: >-
      {"git_revision": "e22c197ab89f3819088e2dd044a508a64f0eec5f", "git_tag": "1.64.2", "git_repository": "/home/runner/work/deployment/deployment", "make_time": "2025-11-14 09:26:21.154760", "variant":
      "stable"}
  CanaryNotificationsTopic:
    Description: SNS topic for notifications about canary errors and failures.
    Value: !Ref 'CanaryNotificationsTopic'
  TabulatorOpenQueryWorkGroup:
    Description: Name of an Athena WorkGroup for Tabulator Open Query
    Value: !Ref 'TabulatorOpenQueryWorkGroup'
    Export:
      Name: !Sub '${AWS::StackName}-TabulatorOpenQueryWorkGroup'
  TabulatorOpenQueryPolicyArn:
    Description: ARN of a Managed Policy for Tabulator Open Query
    Value: !Ref 'TabulatorOpenQueryPolicy'
    Export:
      Name: !Sub '${AWS::StackName}-TabulatorOpenQueryPolicyArn'
Parameters:
  AdminEmail:
    Type: String
    MinLength: 5
    AllowedPattern: '[^\s@]+@[^\s@]+\.[^\s@]+'
    Description: Email for Quilt administrator (the account will be created for you).
  AdminPassword:
    Type: String
    AllowedPattern: .{8,64}|
    NoEcho: true
    Description: >-
      Optional password for Quilt administrator. Requires PasswordAuth to be Enabled. Has no effect if SSO is in use, or was in use when the admin was first created. Has no effect on pre-existing admin
      username/password pairs.
  DBUrl:
    Type: String
    MinLength: 1
    NoEcho: true
    Description: URL of the Quilt server's database in the postgresql://{user}:{password}@{address}:{port}/{dbname} format
  DBAccessorSecurityGroup:
    Description: Security group for services that need to access the database
    Type: AWS::EC2::SecurityGroup::Id
  CertificateArnELB:
    Type: String
    AllowedPattern: ^arn:aws(-us-gov)?:acm:.*$
    Description: SSL certificate in the stack's region for the Quilt load balancer ('arn:aws:acm:...' format). See Amazon Certificate Manager for details.
  QuiltWebHost:
    Type: String
    MinLength: 1
    AllowedPattern: ^[-\w]+\.[-\w]+\.[-\w]+$
    Description: Domain name where your users access Quilt on the web. Must match CertificateArnELB. Must have the subdomain depth specified on your installation form.
  QuiltCatalogPackageRoot:
    Type: String
    AllowedPattern: ^$|^[^\s](.*[^\s])?$
    Description: Prefix inside each bucket where the package files will be uploaded.
    Default: ''
  WAFGeofenceCountries:
    Type: String
    AllowedPattern: ^((\*)|(([A-Z]{2}(,[A-Z]{2})*)))$
    Default: '*'
    Description: 'Countries allowed to access the Quilt catalog. Comma-separated list of Alpha-2 ISO 3166 codes. ''*'' to allow ALL countries access. Example: ''US,CA'' for U.S.A. and Canada.'
  WAFRequestRateLimit:
    Type: Number
    Default: 8400
    MinValue: 100
    Description: Total request rate limit per IP per 5 min. If ATP is enabled then /login has its own (lower) volumetric limit.
  SearchDomainArn:
    Type: String
    MinLength: 1
    Description: ElasticSearch domain ARN
  SearchDomainEndpoint:
    Type: String
    MinLength: 1
    Description: ElasticSearch domain endpoint (without https://)
  SearchClusterAccessorSecurityGroup:
    Description: Security group for services that need to access the search cluster
    Type: AWS::EC2::SecurityGroup::Id
  PasswordAuth:
    Type: String
    AllowedValues:
      - Enabled
      - Disabled
    Description: Allow Quilt to authenticate users via email and password (for external collaborators without SSO)
    Default: Enabled
  GoogleAuth:
    Type: String
    AllowedValues:
      - Enabled
      - Disabled
    Description: Google authentication
    Default: Disabled
  GoogleClientId:
    Type: String
    Description: 'Client ID for Google Auth OAuth2 Client; Create an OAuth2 Client for your domain by following the instructions here: see https://developers.google.com/identity/protocols/OAuth2UserAgent'
  GoogleClientSecret:
    Type: String
    NoEcho: true
    Description: Client secret for Google Auth
  OktaAuth:
    Type: String
    AllowedValues:
      - Enabled
      - Disabled
    Description: Okta authentication
    Default: Disabled
  OktaClientId:
    Type: String
    Description: Client ID for Okta Auth
  OktaClientSecret:
    Type: String
    NoEcho: true
    Description: Client secret for Okta Auth
  OktaBaseUrl:
    Type: String
    Description: Base URL for Okta
  OneLoginAuth:
    Type: String
    AllowedValues:
      - Enabled
      - Disabled
    Description: OneLogin authentication
    Default: Disabled
  OneLoginClientId:
    Type: String
    Description: Client ID for OneLogin Auth
  OneLoginClientSecret:
    Type: String
    NoEcho: true
    Description: Client secret for OneLogin Auth
  OneLoginBaseUrl:
    Type: String
    Description: Base URL for OneLogin
  AzureAuth:
    Type: String
    AllowedValues:
      - Enabled
      - Disabled
    Description: Azure authentication
    Default: Disabled
  AzureClientId:
    Type: String
    Description: Client ID for Azure Auth
  AzureClientSecret:
    Type: String
    NoEcho: true
    Description: Client secret for Azure Auth
  AzureBaseUrl:
    Type: String
    Description: Base URL for Azure (e.g. https://login.microsoftonline.com/01234567-89ab-cdef-0123-456789abcdef)
  SingleSignOnDomains:
    Type: String
    Description: Comma-separated list of G Suite domains that can log into Quilt (e.g. 'mycompany1.com, mycompany2.com')
  VPC:
    Description: VPC to use
    Type: AWS::EC2::VPC::Id
  Subnets:
    Description: List of private subnets for Quilt service containers. Must route traffic to public AWS services (e.g. via NAT Gateway).
    Type: List<AWS::EC2::Subnet::Id>
  UserSecurityGroup:
    Description: >-
      Custom ingress to the Quilt load balancer. Must allow ingress from web catalog users on ports 443 and 80 (80 redirects to 443).See https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-update-security-groups.html
      for suggested settings.
    Type: AWS::EC2::SecurityGroup::Id
  PublicSubnets:
    Description: List of public subnets for the Quilt load balancer
    Type: List<AWS::EC2::Subnet::Id>
  CloudTrailBucket:
    Type: String
    MinLength: 3
    Description: Bucket configured for CloudTrail events from buckets attached to Quilt
  ChunkedChecksums:
    Type: String
    AllowedValues:
      - Enabled
      - Disabled
    Description: Use chunked checksums while creating / modifying packages via Catalog UI (faster package creation, up to 100x package size limit).
    Default: Enabled
  Qurator:
    Type: String
    AllowedValues:
      - Enabled
      - Disabled
    Description: Enable beta Qurator AI Assistant (powered by Amazon Bedrock)
    Default: Disabled
  S3BucketPolicyExcludeArnsFromDeny:
    Type: CommaDelimitedList
    Description: Comma-separated list of ARNs to exclude from the S3 bucket policy deny statement. Useful for allowing specific IAM principals to access the buckets.
    Default: ''
  CanaryNotificationsEmail:
    Type: String
    MinLength: 3
    Description: Email that receives GxP qualification notifications.
  UserAthenaBytesScannedCutoff:
    Description: The upper data usage limit (cutoff) for the amount of bytes a single query in a workgroup is allowed to scan. Set to 0 do disable. Minimum value is 10000000.
    Type: Number
    Default: 0
    MinValue: 0
  ManagedUserRoleExtraPolicies:
    Type: String
    Default: ''
    AllowedPattern: ^([^,]+(,[^,]+){0,4})?$
    Description: >-
      Optional, comma-separated list of up to five IAM policy ARNs. No spaces allowed. A subset of these policies can be attached to one or more roles that Quilt assumes for users. Fill in this parameter
      if you plan to attach your own custom IAM policies to Quilt roles.
  VoilaVersion:
    Type: String
    Default: '0.2.10'
    AllowedValues:
      - '0.2.10'
      - '0.5.8'
    Description: Version of Voila to use.
  VoilaAMI:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ecs/optimized-ami/amazon-linux-2023/recommended/image_id
  AccessCountsRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the AccessCountsRole
  AmazonECSTaskExecutionRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the AmazonECSTaskExecutionRole
  ApiRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the ApiRole
  BucketReadPolicy:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:policy\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the BucketReadPolicy
  BucketWritePolicy:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:policy\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the BucketWritePolicy
  DuckDBSelectLambdaRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the DuckDBSelectLambdaRole
  EsIngestRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the EsIngestRole
  IcebergLambdaRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the IcebergLambdaRole
  ManagedUserRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the ManagedUserRole
  ManagedUserRoleBasePolicy:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:policy\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the ManagedUserRoleBasePolicy
  ManifestIndexerRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the ManifestIndexerRole
  MigrationLambdaRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the MigrationLambdaRole
  PackagerRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the PackagerRole
  PkgEventsRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the PkgEventsRole
  PkgPushRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the PkgPushRole
  RegistryAssumeRolePolicy:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:policy\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the RegistryAssumeRolePolicy
  S3CopyLambdaRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the S3CopyLambdaRole
  S3HashLambdaRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the S3HashLambdaRole
  S3ProxyRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the S3ProxyRole
  S3SNSToEventBridgeRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the S3SNSToEventBridgeRole
  SearchHandlerRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the SearchHandlerRole
  T4BucketReadRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the T4BucketReadRole
  T4BucketWriteRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the T4BucketWriteRole
  T4DefaultBucketReadPolicy:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:policy\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the T4DefaultBucketReadPolicy
  TabulatorOpenQueryPolicy:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:policy\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the TabulatorOpenQueryPolicy
  TabulatorOpenQueryRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the TabulatorOpenQueryRole
  TabulatorRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the TabulatorRole
  TimestampResourceHandlerRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the TimestampResourceHandlerRole
  TrackingCronRole:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:role\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the TrackingCronRole
  UserAthenaManagedRolePolicy:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:policy\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the UserAthenaManagedRolePolicy
  UserAthenaNonManagedRolePolicy:
    Type: String
    MinLength: 1
    AllowedPattern: ^arn:aws:iam::[0-9]{12}:policy\/[a-zA-Z0-9+=,.@_\-\/]+$
    Description: ARN of the UserAthenaNonManagedRolePolicy
Resources:
  LogGroup:
    Properties:
      LogGroupName: !Ref 'AWS::StackName'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  OutboundSecurityGroup:
    Properties:
      GroupDescription: Outbound HTTPS traffic to anywhere
      VpcId: !Ref 'VPC'
      SecurityGroupEgress:
        - CidrIp: '0.0.0.0/0'
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
        - CidrIpv6: ::/0
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
        - CidrIp: '0.0.0.0/0'
          IpProtocol: tcp
          FromPort: 53
          ToPort: 53
        - CidrIpv6: ::/0
          IpProtocol: tcp
          FromPort: 53
          ToPort: 53
        - CidrIp: '0.0.0.0/0'
          IpProtocol: udp
          FromPort: 53
          ToPort: 53
        - CidrIpv6: ::/0
          IpProtocol: udp
          FromPort: 53
          ToPort: 53
    Type: AWS::EC2::SecurityGroup
  ElbPrivateAccessorSecurityGroup:
    Properties:
      GroupDescription: For accessing the ELB private listener port
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::SecurityGroup
  ElbPrivateSecurityGroup:
    Properties:
      GroupName: !Sub 'elb-pri-${AWS::StackName}'
      GroupDescription: Private access to load balancer from services
      VpcId: !Ref 'VPC'
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref 'ElbPrivateAccessorSecurityGroup'
          IpProtocol: tcp
          FromPort: 444
          ToPort: 444
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-elb'
    Type: AWS::EC2::SecurityGroup
  ElbPrivateAccessorSecurityGroupEgress:
    Properties:
      GroupId: !Ref 'ElbPrivateAccessorSecurityGroup'
      DestinationSecurityGroupId: !Ref 'ElbPrivateSecurityGroup'
      IpProtocol: tcp
      FromPort: 444
      ToPort: 444
    Type: AWS::EC2::SecurityGroupEgress
  ElbTargetSecurityGroup:
    Properties:
      GroupDescription: For ELB target groups
      VpcId: !Ref 'VPC'
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref 'ElbPrivateSecurityGroup'
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
      SecurityGroupEgress:
        - CidrIp: 127.0.0.1/32
          IpProtocol: '-1'
    Type: AWS::EC2::SecurityGroup
  ElbSecurityGroupEgress:
    Properties:
      GroupId: !Ref 'ElbPrivateSecurityGroup'
      DestinationSecurityGroupId: !Ref 'ElbTargetSecurityGroup'
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
    Type: AWS::EC2::SecurityGroupEgress
  LoadBalancer:
    Properties:
      Scheme: internet-facing
      Subnets: !Ref 'PublicSubnets'
      LoadBalancerAttributes:
        - Key: idle_timeout.timeout_seconds
          Value: '1000'
      SecurityGroups:
        - !Ref 'ElbPrivateSecurityGroup'
        - !Ref 'UserSecurityGroup'
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
  Listener:
    Properties:
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: '404'
            ContentType: text/plain
            MessageBody: Nothing to see here.
      LoadBalancerArn: !Ref 'LoadBalancer'
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref 'CertificateArnELB'
      SslPolicy: ELBSecurityPolicy-TLS13-1-2-2021-06
    Type: AWS::ElasticLoadBalancingV2::Listener
  InsecureListener:
    Properties:
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            StatusCode: HTTP_301
      LoadBalancerArn: !Ref 'LoadBalancer'
      Port: 80
      Protocol: HTTP
    Type: AWS::ElasticLoadBalancingV2::Listener
  Cluster:
    Properties:
      ClusterName: !Ref 'AWS::StackName'
    Type: AWS::ECS::Cluster
  BadPathPatternSet:
    Properties:
      RegularExpressionList:
        - ^/\.git
        - /\.?env/?$
        - ^/adm/
        - \.(php|asp|aspx|jsp)[\?\/]?
        - /.*/admin.*
      Scope: REGIONAL
    Type: AWS::WAFv2::RegexPatternSet
  WafBadPathPatternSetExcludes:
    Properties:
      RegularExpressionList:
        - ^/api/admin/reindex/
        - ^/browse/[^/]+/
        - ^/zip/package/
        - ^/zip/dir/
        - ^/[^/]+\.s3\.[^/]+\.amazonaws.com/
        - ^/voila/
      Scope: REGIONAL
    Type: AWS::WAFv2::RegexPatternSet
  AppPathPatternSet:
    Properties:
      RegularExpressionList:
        - \.log(\?.*)?$
        - ^/api/service_login$
        - \.s3\..*\.amazonaws\.com/
        - /[^/]*\.js$
      Scope: REGIONAL
    Type: AWS::WAFv2::RegexPatternSet
  WebACL:
    Properties:
      Scope: REGIONAL
      Description: Protect Quilt load balancer and services
      DefaultAction:
        Allow: {}
      Rules:
        - SingleSignOn
        -   - IsWAFGeofenceCountriesEmpty
            -   - Name: BlockNonQuilt
                  Action:
                    Block: {}
                  Statement:
                    AndStatement:
                      Statements:
                        - NotStatement:
                            Statement:
                              RegexPatternSetReferenceStatement:
                                Arn: !GetAtt 'WafBadPathPatternSetExcludes.Arn'
                                FieldToMatch:
                                  UriPath: {}
                                TextTransformations:
                                  - Priority: 0
                                    Type: NONE
                        - RegexPatternSetReferenceStatement:
                            Arn: !GetAtt 'BadPathPatternSet.Arn'
                            FieldToMatch:
                              UriPath: {}
                            TextTransformations:
                              - Priority: 0
                                Type: LOWERCASE
                  Priority: 0
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: BlockNonQuiltMetric
                - Name: RateLimitingRule
                  Action:
                    Block: {}
                  Statement:
                    RateBasedStatement:
                      Limit: !Ref 'WAFRequestRateLimit'
                      AggregateKeyType: IP
                  Priority: 3
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: RateLimitingRuleMetric
                - Name: AllowQuiltPaths
                  Action:
                    Allow: {}
                  Statement:
                    RegexPatternSetReferenceStatement:
                      Arn: !GetAtt 'AppPathPatternSet.Arn'
                      FieldToMatch:
                        UriPath: {}
                      TextTransformations:
                        - Priority: 0
                          Type: NONE
                  Priority: 4
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AllowQuiltPathsMetric
                - Name: AWS-AWSManagedRulesCommonRuleSet
                  Statement:
                    ManagedRuleGroupStatement:
                      Name: AWSManagedRulesCommonRuleSet
                      VendorName: AWS
                      RuleActionOverrides:
                        - Name: SizeRestrictions_BODY
                          ActionToUse:
                            Count: {}
                        - Name: GenericLFI_BODY
                          ActionToUse:
                            Count: {}
                  Priority: 5
                  OverrideAction:
                    None: {}
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AWS-AWSManagedRulesCommonRuleSetMetric
            -   - Name: BlockNonQuilt
                  Action:
                    Block: {}
                  Statement:
                    AndStatement:
                      Statements:
                        - NotStatement:
                            Statement:
                              RegexPatternSetReferenceStatement:
                                Arn: !GetAtt 'WafBadPathPatternSetExcludes.Arn'
                                FieldToMatch:
                                  UriPath: {}
                                TextTransformations:
                                  - Priority: 0
                                    Type: NONE
                        - RegexPatternSetReferenceStatement:
                            Arn: !GetAtt 'BadPathPatternSet.Arn'
                            FieldToMatch:
                              UriPath: {}
                            TextTransformations:
                              - Priority: 0
                                Type: LOWERCASE
                  Priority: 0
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: BlockNonQuiltMetric
                - Name: GeofenceRule
                  Action:
                    Block: {}
                  Statement:
                    NotStatement:
                      Statement:
                        GeoMatchStatement:
                          CountryCodes:
                            - ','
                            - !Ref 'WAFGeofenceCountries'
                  Priority: 2
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: GeofenceRuleMetric
                - Name: RateLimitingRule
                  Action:
                    Block: {}
                  Statement:
                    RateBasedStatement:
                      Limit: !Ref 'WAFRequestRateLimit'
                      AggregateKeyType: IP
                  Priority: 3
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: RateLimitingRuleMetric
                - Name: AllowQuiltPaths
                  Action:
                    Allow: {}
                  Statement:
                    RegexPatternSetReferenceStatement:
                      Arn: !GetAtt 'AppPathPatternSet.Arn'
                      FieldToMatch:
                        UriPath: {}
                      TextTransformations:
                        - Priority: 0
                          Type: NONE
                  Priority: 4
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AllowQuiltPathsMetric
                - Name: AWS-AWSManagedRulesCommonRuleSet
                  Statement:
                    ManagedRuleGroupStatement:
                      Name: AWSManagedRulesCommonRuleSet
                      VendorName: AWS
                      RuleActionOverrides:
                        - Name: SizeRestrictions_BODY
                          ActionToUse:
                            Count: {}
                        - Name: GenericLFI_BODY
                          ActionToUse:
                            Count: {}
                  Priority: 5
                  OverrideAction:
                    None: {}
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AWS-AWSManagedRulesCommonRuleSetMetric
                - Name: AWS-AWSManagedRulesAnonymousIpList
                  Statement:
                    ManagedRuleGroupStatement:
                      Name: AWSManagedRulesAnonymousIpList
                      VendorName: AWS
                  Priority: 6
                  OverrideAction:
                    None: {}
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AWS-AWSManagedRulesAnonymousIpListMetric
        -   - IsWAFGeofenceCountriesEmpty
            -   - Name: BlockNonQuilt
                  Action:
                    Block: {}
                  Statement:
                    AndStatement:
                      Statements:
                        - NotStatement:
                            Statement:
                              RegexPatternSetReferenceStatement:
                                Arn: !GetAtt 'WafBadPathPatternSetExcludes.Arn'
                                FieldToMatch:
                                  UriPath: {}
                                TextTransformations:
                                  - Priority: 0
                                    Type: NONE
                        - RegexPatternSetReferenceStatement:
                            Arn: !GetAtt 'BadPathPatternSet.Arn'
                            FieldToMatch:
                              UriPath: {}
                            TextTransformations:
                              - Priority: 0
                                Type: LOWERCASE
                  Priority: 0
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: BlockNonQuiltMetric
                - Name: AWS-AWSManagedRulesATPRuleSet
                  Statement:
                    ManagedRuleGroupStatement:
                      Name: AWSManagedRulesATPRuleSet
                      VendorName: AWS
                      RuleActionOverrides:
                        - Name: SignalMissingCredential
                          ActionToUse:
                            Count: {}
                      ManagedRuleGroupConfigs:
                        - AWSManagedRulesATPRuleSet:
                            LoginPath: /api/login
                            EnableRegexInPath: false
                            RequestInspection:
                              PayloadType: JSON
                              UsernameField:
                                Identifier: /username
                              PasswordField:
                                Identifier: /password
                  Priority: 1
                  OverrideAction:
                    None: {}
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AWS-AWSManagedRulesATPRuleSetMetric
                - Name: RateLimitingRule
                  Action:
                    Block: {}
                  Statement:
                    RateBasedStatement:
                      Limit: !Ref 'WAFRequestRateLimit'
                      AggregateKeyType: IP
                  Priority: 3
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: RateLimitingRuleMetric
                - Name: AllowQuiltPaths
                  Action:
                    Allow: {}
                  Statement:
                    RegexPatternSetReferenceStatement:
                      Arn: !GetAtt 'AppPathPatternSet.Arn'
                      FieldToMatch:
                        UriPath: {}
                      TextTransformations:
                        - Priority: 0
                          Type: NONE
                  Priority: 4
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AllowQuiltPathsMetric
                - Name: AWS-AWSManagedRulesCommonRuleSet
                  Statement:
                    ManagedRuleGroupStatement:
                      Name: AWSManagedRulesCommonRuleSet
                      VendorName: AWS
                      RuleActionOverrides:
                        - Name: SizeRestrictions_BODY
                          ActionToUse:
                            Count: {}
                        - Name: GenericLFI_BODY
                          ActionToUse:
                            Count: {}
                  Priority: 5
                  OverrideAction:
                    None: {}
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AWS-AWSManagedRulesCommonRuleSetMetric
            -   - Name: BlockNonQuilt
                  Action:
                    Block: {}
                  Statement:
                    AndStatement:
                      Statements:
                        - NotStatement:
                            Statement:
                              RegexPatternSetReferenceStatement:
                                Arn: !GetAtt 'WafBadPathPatternSetExcludes.Arn'
                                FieldToMatch:
                                  UriPath: {}
                                TextTransformations:
                                  - Priority: 0
                                    Type: NONE
                        - RegexPatternSetReferenceStatement:
                            Arn: !GetAtt 'BadPathPatternSet.Arn'
                            FieldToMatch:
                              UriPath: {}
                            TextTransformations:
                              - Priority: 0
                                Type: LOWERCASE
                  Priority: 0
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: BlockNonQuiltMetric
                - Name: AWS-AWSManagedRulesATPRuleSet
                  Statement:
                    ManagedRuleGroupStatement:
                      Name: AWSManagedRulesATPRuleSet
                      VendorName: AWS
                      RuleActionOverrides:
                        - Name: SignalMissingCredential
                          ActionToUse:
                            Count: {}
                      ManagedRuleGroupConfigs:
                        - AWSManagedRulesATPRuleSet:
                            LoginPath: /api/login
                            EnableRegexInPath: false
                            RequestInspection:
                              PayloadType: JSON
                              UsernameField:
                                Identifier: /username
                              PasswordField:
                                Identifier: /password
                  Priority: 1
                  OverrideAction:
                    None: {}
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AWS-AWSManagedRulesATPRuleSetMetric
                - Name: GeofenceRule
                  Action:
                    Block: {}
                  Statement:
                    NotStatement:
                      Statement:
                        GeoMatchStatement:
                          CountryCodes:
                            - ','
                            - !Ref 'WAFGeofenceCountries'
                  Priority: 2
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: GeofenceRuleMetric
                - Name: RateLimitingRule
                  Action:
                    Block: {}
                  Statement:
                    RateBasedStatement:
                      Limit: !Ref 'WAFRequestRateLimit'
                      AggregateKeyType: IP
                  Priority: 3
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: RateLimitingRuleMetric
                - Name: AllowQuiltPaths
                  Action:
                    Allow: {}
                  Statement:
                    RegexPatternSetReferenceStatement:
                      Arn: !GetAtt 'AppPathPatternSet.Arn'
                      FieldToMatch:
                        UriPath: {}
                      TextTransformations:
                        - Priority: 0
                          Type: NONE
                  Priority: 4
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AllowQuiltPathsMetric
                - Name: AWS-AWSManagedRulesCommonRuleSet
                  Statement:
                    ManagedRuleGroupStatement:
                      Name: AWSManagedRulesCommonRuleSet
                      VendorName: AWS
                      RuleActionOverrides:
                        - Name: SizeRestrictions_BODY
                          ActionToUse:
                            Count: {}
                        - Name: GenericLFI_BODY
                          ActionToUse:
                            Count: {}
                  Priority: 5
                  OverrideAction:
                    None: {}
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AWS-AWSManagedRulesCommonRuleSetMetric
                - Name: AWS-AWSManagedRulesAnonymousIpList
                  Statement:
                    ManagedRuleGroupStatement:
                      Name: AWSManagedRulesAnonymousIpList
                      VendorName: AWS
                  Priority: 6
                  OverrideAction:
                    None: {}
                  VisibilityConfig:
                    SampledRequestsEnabled: true
                    CloudWatchMetricsEnabled: true
                    MetricName: AWS-AWSManagedRulesAnonymousIpListMetric
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: WebACLMetric
    Type: AWS::WAFv2::WebACL
  ELBv2WebACLAssociation:
    Properties:
      WebACLArn: !GetAtt 'WebACL.Arn'
      ResourceArn: !Ref 'LoadBalancer'
    Type: AWS::WAFv2::WebACLAssociation
  DnsNamespace:
    Properties:
      Name: !Sub '${AWS::StackName}'
      Vpc: !Ref 'VPC'
    Type: AWS::ServiceDiscovery::PrivateDnsNamespace
  DeadLetterQueue:
    Properties:
      SqsManagedSseEnabled: true
    Type: AWS::SQS::Queue
  IndexerQueue:
    Properties:
      DelaySeconds: 0
      VisibilityTimeout: 5401
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt 'DeadLetterQueue.Arn'
        maxReceiveCount: 15
      SqsManagedSseEnabled: true
    Type: AWS::SQS::Queue
  IndexingPerBucketConfigs:
    Properties:
      Name: !Sub '/quilt/${AWS::StackName}/Indexing/PerBucketConfigs'
      Type: String
      Value: '{}'
    Type: AWS::SSM::Parameter
  SearchHandlerLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/SearchHandler'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  SearchHandler:
    Properties:
      Role: !Ref 'SearchHandlerRole'
      Timeout: 900
      MemorySize: 512
      ReservedConcurrentExecutions: 80
      Environment:
        Variables:
          CONTENT_INDEX_EXTS: .csv, .fcs, .html, .ipynb, .json, .md, .parquet, .pdf, .pptx, .rmd, .rst, .tab, .tsv, .txt, .xls, .xlsx
          ES_ENDPOINT:
            - https://${ES_HOST}
            - ES_HOST: !Ref 'SearchDomainEndpoint'
          SKIP_ROWS_EXTS: ''
          DOC_LIMIT_BYTES: 1000000
          PER_BUCKET_CONFIGS: !GetAtt 'IndexingPerBucketConfigs.Value'
          MANIFEST_INDEXER_QUEUE_URL: !GetAtt 'ManifestIndexerQueue.QueueUrl'
          CHUNK_LIMIT_BYTES: 99000000
      PackageType: Image
      Code:
        ImageUri:
          - ${AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/quiltdata/lambdas/indexer:b5192ec0bab975559ea8e9196ca1aff64ed81eec
          - AccountId:
              - GovCloud
              - !Ref 'AWS::AccountId'
              -   - PartitionConfig
                  - !Ref 'AWS::Partition'
                  - AccountId
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
          - !Ref 'SearchClusterAccessorSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'SearchHandlerLogGroup'
    Type: AWS::Lambda::Function
  LambdaFunctionEventSourceMapping:
    Properties:
      BatchSize: 100
      MaximumBatchingWindowInSeconds: 1
      Enabled: true
      EventSourceArn: !GetAtt 'IndexerQueue.Arn'
      FunctionName: !GetAtt 'SearchHandler.Arn'
      ScalingConfig:
        MaximumConcurrency: 80
    Type: AWS::Lambda::EventSourceMapping
  EsIngestDeadLetterQueue:
    Type: AWS::SQS::Queue
  EsIngestQueue:
    Properties:
      VisibilityTimeout: 420
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt 'EsIngestDeadLetterQueue.Arn'
        maxReceiveCount: 20
      MessageRetentionPeriod: 345600
    Type: AWS::SQS::Queue
  EsIngestBucket:
    Properties:
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldObjects
            Status: Enabled
            ExpirationInDays: 4
            NoncurrentVersionExpirationInDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
    Type: AWS::S3::Bucket
  EsIngestBucketPolicy:
    Properties:
      Bucket: !Ref 'EsIngestBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'EsIngestBucket.Arn'
              - !Sub '${EsIngestBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
    Type: AWS::S3::BucketPolicy
  EsIngestRule:
    Properties:
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - Object Created
        resources:
          - !GetAtt 'EsIngestBucket.Arn'
      State: ENABLED
      Targets:
        - Arn: !GetAtt 'EsIngestQueue.Arn'
          Id: EsIngestQueue
    Type: AWS::Events::Rule
  EsIngestQueuePolicy:
    Properties:
      Queues:
        - !Ref 'EsIngestQueue'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt 'EsIngestQueue.Arn'
            Condition:
              ArnLike:
                aws:SourceArn: !GetAtt 'EsIngestRule.Arn'
    Type: AWS::SQS::QueuePolicy
  EsIngestLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/EsIngestLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  EsIngestLambda:
    Properties:
      Handler: t4_lambda_es_ingest.handler
      Role: !Ref 'EsIngestRole'
      Runtime: python3.11
      Timeout: 70
      MemorySize: 160
      ReservedConcurrentExecutions: 20
      Environment:
        Variables:
          ES_ENDPOINT:
            - https://${ES_HOST}
            - ES_HOST: !Ref 'SearchDomainEndpoint'
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: es_ingest/a1e390d1b014f8cbebc18f61ad76860a0214bf6d.zip
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
          - !Ref 'SearchClusterAccessorSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'EsIngestLambdaLogGroup'
    Type: AWS::Lambda::Function
  EsIngestEventSourceMapping:
    Properties:
      BatchSize: 1
      FunctionName: !GetAtt 'EsIngestLambda.Arn'
      EventSourceArn: !GetAtt 'EsIngestQueue.Arn'
      Enabled: true
      ScalingConfig:
        MaximumConcurrency: 20
    Type: AWS::Lambda::EventSourceMapping
  ManifestIndexerDeadLetterQueue:
    Type: AWS::SQS::Queue
  ManifestIndexerQueue:
    Properties:
      VisibilityTimeout: 5400
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt 'ManifestIndexerDeadLetterQueue.Arn'
        maxReceiveCount: 10
    Type: AWS::SQS::Queue
  ManifestIndexerLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/ManifestIndexerLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  ManifestIndexerLambda:
    Properties:
      Handler: t4_lambda_manifest_indexer.handler
      Role: !Ref 'ManifestIndexerRole'
      Runtime: python3.11
      Timeout: 900
      MemorySize: 1024
      ReservedConcurrentExecutions: 10
      Environment:
        Variables:
          ES_ENDPOINT:
            - https://${ES_HOST}
            - ES_HOST: !Ref 'SearchDomainEndpoint'
          ES_INGEST_BUCKET: !Ref 'EsIngestBucket'
          BATCH_MAX_BYTES: 8000000
          BATCH_MAX_DOCS: 10000
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: manifest_indexer/e0ae23a6e530b626d6fe0e1704a1c7361e33613f.zip
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
          - !Ref 'SearchClusterAccessorSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'ManifestIndexerLambdaLogGroup'
    Type: AWS::Lambda::Function
    DependsOn: EsIngestQueuePolicy
  ManifestIndexerEventSourceMapping:
    Properties:
      BatchSize: 1
      FunctionName: !GetAtt 'ManifestIndexerLambda.Arn'
      EventSourceArn: !GetAtt 'ManifestIndexerQueue.Arn'
      Enabled: true
      ScalingConfig:
        MaximumConcurrency: 10
    Type: AWS::Lambda::EventSourceMapping
  AnalyticsBucket:
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedMethods:
              - GET
              - HEAD
              - POST
            AllowedOrigins:
              - '*'
            AllowedHeaders:
              - '*'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
    Type: AWS::S3::Bucket
  AnalyticsBucketPolicy:
    Properties:
      Bucket: !Ref 'AnalyticsBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'AnalyticsBucket.Arn'
              - !Sub '${AnalyticsBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
    Type: AWS::S3::BucketPolicy
  AthenaDatabase:
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseInput:
        Name:
          - _
          -   - '-'
              - !Ref 'AnalyticsBucket'
    Type: AWS::Glue::Database
  NamedPackagesAthenaTable:
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseName: !Ref 'AthenaDatabase'
      TableInput:
        Name: named_packages
        TableType: EXTERNAL_TABLE
        PartitionKeys:
          - Name: bucket
            Type: string
        StorageDescriptor:
          Columns:
            - Name: hash
              Type: string
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub 's3://${AnalyticsBucket}/named_packages/'
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
    Type: AWS::Glue::Table
  AccessCountsLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/AccessCountsLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  AccessCountsLambda:
    Properties:
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: access_counts/207546e5fbae466955781f22cf88101a78193367.zip
      Handler: index.handler
      Role: !Ref 'AccessCountsRole'
      Runtime: python3.11
      Timeout: 900
      MemorySize: 192
      ReservedConcurrentExecutions: 1
      Environment:
        Variables:
          ATHENA_DATABASE: !Ref 'AthenaDatabase'
          CLOUDTRAIL_BUCKET: !Ref 'CloudTrailBucket'
          QUERY_RESULT_BUCKET: !Ref 'AnalyticsBucket'
          ACCESS_COUNTS_OUTPUT_DIR: AccessCounts
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'AccessCountsLambdaLogGroup'
    Type: AWS::Lambda::Function
  AccessCountsCron:
    Properties:
      ScheduleExpression: rate(1 hour)
      Targets:
        - Arn: !GetAtt 'AccessCountsLambda.Arn'
          Id: AccessCounts
    Type: AWS::Events::Rule
  AccessCountPermission:
    Properties:
      FunctionName: !GetAtt 'AccessCountsLambda.Arn'
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt 'AccessCountsCron.Arn'
    Type: AWS::Lambda::Permission
  UserAthenaDatabase:
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseInput: {}
    Type: AWS::Glue::Database
  UserAthenaResultsBucket:
    Properties:
      LifecycleConfiguration:
        Rules:
          - Id: delete-user-athena-results
            Status: Enabled
            Prefix: athena-results/
            ExpirationInDays: 1
            NoncurrentVersionExpirationInDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
    Type: AWS::S3::Bucket
  UserAthenaResultsBucketPolicy:
    Properties:
      Bucket: !Ref 'UserAthenaResultsBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'UserAthenaResultsBucket.Arn'
              - !Sub '${UserAthenaResultsBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
          - Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !Sub '${UserAthenaResultsBucket.Arn}'
              - !Sub '${UserAthenaResultsBucket.Arn}/*'
            Condition:
              ForAllValues:StringNotEquals:
                aws:CalledVia:
                  - athena.amazonaws.com
                  - cloudformation.amazonaws.com
              StringNotEquals:
                aws:PrincipalArn:
                  - ','
                  -   - ${base_arns}${extra_arns}
                      - base_arns:
                          - ','
                          -   - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/access-analyzer.amazonaws.com/AWSServiceRoleForAccessAnalyzer'
                        extra_arns:
                          - S3BucketPolicyExcludeArnsFromDenyEmpty
                          - ''
                          -   - ',${param}'
                              - param:
                                  - ','
                                  - !Ref 'S3BucketPolicyExcludeArnsFromDeny'
    Type: AWS::S3::BucketPolicy
  UserAthenaNonManagedRoleWorkgroup:
    Properties:
      Name: !Sub 'QuiltUserAthena-${AWS::StackName}-NonManagedRoleWorkgroup'
      Description: !Sub 'Workgroup for non-managed roles in Quilt stack ${AWS::StackName}'
      RecursiveDeleteOption: true
      WorkGroupConfiguration:
        EnforceWorkGroupConfiguration: true
        BytesScannedCutoffPerQuery:
          - UserAthenaBytesScannedCutoffDisabled
          - !Ref 'AWS::NoValue'
          - !Ref 'UserAthenaBytesScannedCutoff'
        ResultConfiguration:
          ExpectedBucketOwner: !Ref 'AWS::AccountId'
          OutputLocation: !Sub 's3://${UserAthenaResultsBucket}/athena-results/non-managed-roles/'
    Type: AWS::Athena::WorkGroup
  EventBus:
    Properties:
      Name: !Sub 'quilt-${AWS::StackName}'
    Type: AWS::Events::EventBus
  S3SNSToEventBridgeDeadLetterQueue:
    Type: AWS::SQS::Queue
  S3SNSToEventBridgeQueue:
    Properties:
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt 'S3SNSToEventBridgeDeadLetterQueue.Arn'
        maxReceiveCount: 5
    Type: AWS::SQS::Queue
  S3SNSToEventBridgeLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/S3SNSToEventBridgeLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  S3SNSToEventBridgeLambda:
    Properties:
      Architectures:
        - arm64
      Runtime: python3.11
      Code:
        ZipFile: |
          import datetime
          import json
          import os

          import boto3

          BUS_ARN = os.environ["BUS_ARN"]
          PARTITION = BUS_ARN.split(":")[1]


          eb = boto3.client("events")


          def make_event(e: dict):
              arn = e["s3"]["bucket"].get("arn")
              if not arn:
                  # this is a hack for events that come from CloudTrail
                  arn = f"arn:{PARTITION}:s3:::{e['s3']['bucket']['name']}"
              if "eventSource" not in e:
                  # this is a hack for events that come from CloudTrail
                  # probably not strictly necessary, but it makes the event more consistent
                  e["eventSource"] = "aws:s3"
              return {
                  "Source": "com.quiltdata.s3",
                  "DetailType": e["eventName"],
                  "Resources": [arn],
                  "Detail": json.dumps(e),
                  "EventBusName": BUS_ARN,
                  "Time": datetime.datetime.fromisoformat(e["eventTime"]),
              }


          def handler(event, context):
              import pprint

              pprint.pprint(event)

              s3_events = [json.loads(r["body"]) for r in event["Records"]]
              # make sure we can do in a single batch
              if len(s3_events) > 10:
                  raise ValueError("Cannot process more than 10 events in a single batch")
              # we expect only one record per event
              # https://repost.aws/questions/QUzbHHiTa4TF2gpTJD8I0vdQ/do-s3-objectcreated-put-event-notidfications-always-contain-a-single-record#ANg9ZF7qF9RfWg6fnPpT5Kow
              # we need that so we can map output events to input messages to return failures
              if any(len(e["Records"]) != 1 for e in s3_events):
                  raise ValueError("Each S3 event must contain exactly one record")
              resp = eb.put_events(Entries=[make_event(e["Records"][0]) for e in s3_events])

              sqs_batch_response = {}
              sqs_batch_response["batchItemFailures"] = batch_item_failures = []
              for r, e in zip(event["Records"], resp["Entries"]):
                  if "ErrorCode" in e:
                      print(e)
                      batch_item_failures.append({"itemIdentifier": r["messageId"]})

              return sqs_batch_response
      Handler: index.handler
      Role: !Ref 'S3SNSToEventBridgeRole'
      Timeout: 10
      MemorySize: 128
      ReservedConcurrentExecutions: 10
      Environment:
        Variables:
          BUS_ARN: !GetAtt 'EventBus.Arn'
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'S3SNSToEventBridgeLambdaLogGroup'
    Type: AWS::Lambda::Function
  S3SNSToEventBridgeLambdaEventSourceMapping:
    Properties:
      BatchSize: 10
      MaximumBatchingWindowInSeconds: 0
      EventSourceArn: !GetAtt 'S3SNSToEventBridgeQueue.Arn'
      FunctionName: !GetAtt 'S3SNSToEventBridgeLambda.Arn'
      FunctionResponseTypes:
        - ReportBatchItemFailures
      ScalingConfig:
        MaximumConcurrency: 10
    Type: AWS::Lambda::EventSourceMapping
  PkgEventsDLQ:
    Properties:
      SqsManagedSseEnabled: true
    Type: AWS::SQS::Queue
  PkgEventsQueue:
    Properties:
      VisibilityTimeout: 240
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt 'PkgEventsDLQ.Arn'
        maxReceiveCount: 15
      SqsManagedSseEnabled: true
    Type: AWS::SQS::Queue
  PkgEventsLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/PkgEvents'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  PkgEvents:
    Properties:
      Runtime: python3.11
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: pkgevents/207546e5fbae466955781f22cf88101a78193367.zip
      Handler: index.handler
      Role: !Ref 'PkgEventsRole'
      Timeout: 30
      MemorySize: 128
      ReservedConcurrentExecutions: 5
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'PkgEventsLogGroup'
    Type: AWS::Lambda::Function
  PkgEventsEventSourceMapping:
    Properties:
      BatchSize: 200
      MaximumBatchingWindowInSeconds: 60
      Enabled: true
      EventSourceArn: !GetAtt 'PkgEventsQueue.Arn'
      FunctionName: !Ref 'PkgEvents'
      ScalingConfig:
        MaximumConcurrency: 5
    Type: AWS::Lambda::EventSourceMapping
  DuckDBSelectLambdaBucket:
    Properties:
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: clean-asap
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpirationInDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
    Type: AWS::S3::Bucket
  DuckDBSelectLambdaBucketPolicy:
    Properties:
      Bucket: !Ref 'DuckDBSelectLambdaBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'DuckDBSelectLambdaBucket.Arn'
              - !Sub '${DuckDBSelectLambdaBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
    Type: AWS::S3::BucketPolicy
  DuckDBSelectLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/DuckDBSelectLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  DuckDBSelectLambda:
    Properties:
      Handler: duckdb_select.lambda_handler
      Role: !Ref 'DuckDBSelectLambdaRole'
      Runtime: python3.12
      Architectures:
        - arm64
      Timeout: 900
      MemorySize: 2048
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: duckdb-select/6b3baebf96616631ca3d61d83bcd39896f7d8119.zip
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'DuckDBSelectLambdaLogGroup'
      Environment:
        Variables:
          RESULTS_BUCKET: !Ref 'DuckDBSelectLambdaBucket'
    Type: AWS::Lambda::Function
  S3HashLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/S3HashLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  S3HashLambda:
    Properties:
      Runtime: python3.11
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: s3hash/c2ff6ba7309fe979c232207eaf9684fa59c278ac.zip
      Handler: t4_lambda_s3hash.lambda_handler
      Role: !Ref 'S3HashLambdaRole'
      Timeout: 900
      MemorySize: 512
      ReservedConcurrentExecutions: 300
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      Environment:
        Variables:
          MPU_CONCURRENCY: '1000'
          CHUNKED_CHECKSUMS:
            - ChunkedChecksumsEnabled
            - 'true'
            - ''
      LoggingConfig:
        LogGroup: !Ref 'S3HashLambdaLogGroup'
    Type: AWS::Lambda::Function
  S3CopyLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/S3CopyLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  S3CopyLambda:
    Properties:
      Runtime: python3.11
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: s3hash/c2ff6ba7309fe979c232207eaf9684fa59c278ac.zip
      Handler: t4_lambda_s3hash.lambda_handler_copy
      Role: !Ref 'S3CopyLambdaRole'
      Timeout: 900
      MemorySize: 512
      ReservedConcurrentExecutions: 150
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      Environment:
        Variables:
          MPU_CONCURRENCY: '1000'
          CHUNKED_CHECKSUMS:
            - ChunkedChecksumsEnabled
            - 'true'
            - ''
      LoggingConfig:
        LogGroup: !Ref 'S3CopyLambdaLogGroup'
    Type: AWS::Lambda::Function
  PkgPromoteLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/PkgPromote'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  PkgPromote:
    Properties:
      Runtime: python3.11
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: pkgpush/9e19d208a4e1899713fcae45ffce34de27b6dfc5.zip
      Handler: t4_lambda_pkgpush.promote_package
      Role: !Ref 'PkgPushRole'
      Timeout: 900
      MemorySize: 1024
      ReservedConcurrentExecutions: 5
      Environment:
        Variables:
          MAX_BYTES_TO_HASH:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '107374182400'
          MAX_FILES_TO_HASH: '5000'
          QUILT_MINIMIZE_STDOUT: 'true'
          PROMOTE_PKG_MAX_FILES: '5000'
          PROMOTE_PKG_MAX_MANIFEST_SIZE: '104857600'
          PROMOTE_PKG_MAX_PKG_SIZE:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '107374182400'
          QUILT_TRANSFER_MAX_CONCURRENCY: '1000'
          S3_HASH_LAMBDA: !Ref 'S3HashLambda'
          S3_COPY_LAMBDA: !Ref 'S3CopyLambda'
          S3_HASH_LAMBDA_CONCURRENCY: 30
          S3_COPY_LAMBDA_CONCURRENCY: 30
          S3_HASH_LAMBDA_MAX_FILE_SIZE_BYTES:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '10737418240'
          SERVICE_BUCKET: !Ref 'ServiceBucket'
          CHUNKED_CHECKSUMS:
            - ChunkedChecksumsEnabled
            - 'true'
            - ''
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'PkgPromoteLogGroup'
    Type: AWS::Lambda::Function
  PkgCreateLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/PkgCreate'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  PkgCreate:
    Properties:
      Runtime: python3.11
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: pkgpush/9e19d208a4e1899713fcae45ffce34de27b6dfc5.zip
      Handler: t4_lambda_pkgpush.create_package
      Role: !Ref 'PkgPushRole'
      Timeout: 900
      MemorySize: 1024
      ReservedConcurrentExecutions: 5
      Environment:
        Variables:
          MAX_BYTES_TO_HASH:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '107374182400'
          MAX_FILES_TO_HASH: '5000'
          QUILT_MINIMIZE_STDOUT: 'true'
          PROMOTE_PKG_MAX_FILES: '5000'
          PROMOTE_PKG_MAX_MANIFEST_SIZE: '104857600'
          PROMOTE_PKG_MAX_PKG_SIZE:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '107374182400'
          QUILT_TRANSFER_MAX_CONCURRENCY: '1000'
          S3_HASH_LAMBDA: !Ref 'S3HashLambda'
          S3_COPY_LAMBDA: !Ref 'S3CopyLambda'
          S3_HASH_LAMBDA_CONCURRENCY: 30
          S3_COPY_LAMBDA_CONCURRENCY: 30
          S3_HASH_LAMBDA_MAX_FILE_SIZE_BYTES:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '10737418240'
          SERVICE_BUCKET: !Ref 'ServiceBucket'
          CHUNKED_CHECKSUMS:
            - ChunkedChecksumsEnabled
            - 'true'
            - ''
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'PkgCreateLogGroup'
    Type: AWS::Lambda::Function
  PackagerDeadLetterQueue:
    Type: AWS::SQS::Queue
  PackagerQueue:
    Properties:
      VisibilityTimeout: 5400
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt 'PackagerDeadLetterQueue.Arn'
        maxReceiveCount: 5
    Type: AWS::SQS::Queue
  PackagerLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/PackagerLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  PackagerLambda:
    Properties:
      Runtime: python3.11
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: pkgpush/9e19d208a4e1899713fcae45ffce34de27b6dfc5.zip
      Handler: t4_lambda_pkgpush.package_prefix_sqs
      Role: !Ref 'PackagerRole'
      Timeout: 900
      MemorySize: 3008
      ReservedConcurrentExecutions: 5
      Environment:
        Variables:
          MAX_BYTES_TO_HASH:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '107374182400'
          MAX_FILES_TO_HASH: '5000'
          QUILT_MINIMIZE_STDOUT: 'true'
          PROMOTE_PKG_MAX_FILES: '5000'
          PROMOTE_PKG_MAX_MANIFEST_SIZE: '104857600'
          PROMOTE_PKG_MAX_PKG_SIZE:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '107374182400'
          QUILT_TRANSFER_MAX_CONCURRENCY: '1000'
          S3_HASH_LAMBDA: !Ref 'S3HashLambda'
          S3_COPY_LAMBDA: !Ref 'S3CopyLambda'
          S3_HASH_LAMBDA_CONCURRENCY: 30
          S3_COPY_LAMBDA_CONCURRENCY: 30
          S3_HASH_LAMBDA_MAX_FILE_SIZE_BYTES:
            - ChunkedChecksumsEnabled
            - '5497558138880'
            - '10737418240'
          SERVICE_BUCKET: !Ref 'ServiceBucket'
          CHUNKED_CHECKSUMS:
            - ChunkedChecksumsEnabled
            - 'true'
            - ''
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'PackagerLambdaLogGroup'
    Type: AWS::Lambda::Function
  PackagerLambdaEventSourceMapping:
    Properties:
      BatchSize: 1
      MaximumBatchingWindowInSeconds: 0
      EventSourceArn: !GetAtt 'PackagerQueue.Arn'
      FunctionName: !GetAtt 'PackagerLambda.Arn'
      ScalingConfig:
        MaximumConcurrency: 5
    Type: AWS::Lambda::EventSourceMapping
  PackagerQueuePolicy:
    Properties:
      Queues:
        - !Ref 'PackagerQueue'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt 'PackagerQueue.Arn'
    Type: AWS::SQS::QueuePolicy
  PackagerROCrateRule:
    Properties:
      EventBusName: !GetAtt 'EventBus.Arn'
      EventPattern:
        source:
          - com.quiltdata.s3
        detail-type:
          - prefix: 'ObjectCreated:'
        detail:
          eventSource:
            - aws:s3
          s3:
            object:
              key:
                - suffix: /ro-crate-metadata.json
      State: DISABLED
      Targets:
        - Arn: !GetAtt 'PackagerQueue.Arn'
          Id: PackagerQueue
          InputTransformer:
            InputPathsMap:
              bucket: $.detail.s3.bucket.name
              key: $.detail.s3.object.key
            InputTemplate: '{"source_prefix": "s3://<bucket>/<key>", "metadata_uri": "s3://<bucket>/<key>"}'
    Type: AWS::Events::Rule
  PackagerOmicsRule:
    Properties:
      EventPattern:
        source:
          - aws.omics
        detail-type:
          - Run Status Change
        detail:
          status:
            - COMPLETED
      State: DISABLED
      Targets:
        - Arn: !GetAtt 'PackagerQueue.Arn'
          Id: PackagerQueue
          InputTransformer:
            InputPathsMap:
              output_uri: $.detail.runOutputUri
            InputTemplate: '{"source_prefix": "<output_uri>/"}'
    Type: AWS::Events::Rule
  RegistryTaskDefinition:
    Properties:
      Family: !Sub '${AWS::StackName}-registry'
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      ExecutionRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      TaskRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      Cpu: '1024'
      Memory: 2GB
      ContainerDefinitions:
        - Name: registry-tmp-volume-chmod
          Essential: false
          Image: public.ecr.aws/docker/library/busybox
          EntryPoint:
            - sh
            - -c
          Command:
            - chmod 1777 /tmp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: registry
          MountPoints:
            - ContainerPath: /tmp/
              SourceVolume: registry-tmp
          ReadonlyRootFilesystem: true
        - Name: registry
          Image:
            - ${AccountId}.dkr.ecr.${Region}.amazonaws.com/quiltdata/registry:${Tag}
            - AccountId:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - AccountId
              Region:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - PrimaryRegion
              Tag: b58572ae7e5126222c7ac306eee022ed2f05450c
          Environment:
            - Name: AWS_DEFAULT_REGION
              Value: !Ref 'AWS::Region'
            - Name: CATALOG_URL
              Value: !Sub 'https://${QuiltWebHost}'
            - Name: GIT_HASH
              Value: vb58572ae7e5126222c7ac306eee022ed2f05450c
            - Name: QUILT_LOG_LEVEL
              Value: INFO
            - Name: QUILT_MANAGED_USER_ROLE_ARN
              Value: !Ref 'ManagedUserRole'
            - Name: QUILT_READ_ROLE_ARN
              Value: !Ref 'T4BucketReadRole'
            - Name: QUILT_QPE_ROLE_ARN
              Value: !Ref 'PackagerRole'
            - Name: QUILT_SERVER_CONFIG
              Value: prod_config.py
            - Name: QUILT_WRITE_ROLE_ARN
              Value: !Ref 'T4BucketWriteRole'
            - Name: SQLALCHEMY_DATABASE_URI
              Value: !Ref 'DBUrl'
            - Name: QUILT_QPE_RO_CRATE_RULE_ARN
              Value: !GetAtt 'PackagerROCrateRule.Arn'
            - Name: QUILT_QPE_OMICS_RULE_ARN
              Value: !GetAtt 'PackagerOmicsRule.Arn'
            - Name: ALLOW_ANONYMOUS_ACCESS
              Value: ''
            - Name: ANALYTICS_CATALOG_ID
              Value: !Ref 'AWS::AccountId'
            - Name: AWS_MP_METERING
              Value: hourly
            - Name: AWS_MP_PRODUCT_CODE
              Value: f5d6l3y7x2yy2fcm0uxr9gglh
            - Name: AWS_MP_PUBLIC_KEY_VERSION
              Value: '1'
            - Name: AWS_STACK_ID
              Value: !Ref 'AWS::StackId'
            - Name: CUSTOMER_ID
              Value: ''
            - Name: DEPLOYMENT_ID
              Value: !Ref 'QuiltWebHost'
            - Name: EMAIL_SERVER
              Value: https://email.quiltdata.com
            - Name: ES_ENDPOINT
              Value:
                - https://${ES_HOST}
                - ES_HOST: !Ref 'SearchDomainEndpoint'
            - Name: MIXPANEL_PROJECT_TOKEN
              Value: e3385877c980efdce0a7eaec5a8a8277
            - Name: QUILT_ADMIN_EMAIL
              Value: !Ref 'AdminEmail'
            - Name: QUILT_ADMIN_PASSWORD
              Value:
                - SsoAuth
                - ''
                - !Ref 'AdminPassword'
            - Name: QUILT_ADMIN_SSO_ONLY
              Value:
                - SsoAuth
                - '1'
                - ''
            - Name: QUILT_ASSUME_ROLE_POLICY_ARN
              Value: !Ref 'RegistryAssumeRolePolicy'
            - Name: QUILT_AUDIT_TRAIL_DELIVERY_STREAM
              Value: !Ref 'AuditTrailDeliveryStream'
            - Name: QUILT_BUCKET_READ_POLICY_ARN
              Value: !Ref 'BucketReadPolicy'
            - Name: QUILT_BUCKET_WRITE_POLICY_ARN
              Value: !Ref 'BucketWritePolicy'
            - Name: QUILT_IAM_PATH
              Value: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
            - Name: QUILT_IAM_POLICY_NAME_PREFIX
              Value: Quilt-
            - Name: QUILT_INDEXER_LAMBDA_ARN
              Value: !GetAtt 'SearchHandler.Arn'
            - Name: QUILT_INDEXING_BUCKET_CONFIGS_PARAMETER
              Value: !Ref 'IndexingPerBucketConfigs'
            - Name: QUILT_INDEXING_CONTENT_BYTES
              Value: '{"default": 1000000, "min": 0, "max": 1048576}'
            - Name: QUILT_INDEXING_CONTENT_EXTENSIONS
              Value: '[".csv", ".fcs", ".html", ".ipynb", ".json", ".md", ".parquet", ".pdf", ".pptx", ".rmd", ".rst", ".tab", ".tsv", ".txt", ".xls", ".xlsx"]'
            - Name: QUILT_PKG_CREATE_LAMBDA_ARN
              Value: !Ref 'PkgCreate'
            - Name: QUILT_PKG_EVENTS_QUEUE_URL
              Value: !Ref 'PkgEventsQueue'
            - Name: QUILT_PKG_PROMOTE_LAMBDA_ARN
              Value: !Ref 'PkgPromote'
            - Name: QUILT_DUCKDB_SELECT_LAMBDA_ARN
              Value: !Ref 'DuckDBSelectLambda'
            - Name: QUILT_SEARCH_MAX_DOCS_PER_SHARD
              Value: '10000'
            - Name: QUILT_SECURE_SEARCH
              Value: ''
            - Name: QUILT_SERVICE_BUCKET
              Value: !Ref 'ServiceBucket'
            - Name: QUILT_SNS_KMS_ID
              Value: !Ref 'SNSKMSKey'
            - Name: QUILT_STACK_NAME
              Value: !Ref 'AWS::StackName'
            - Name: QUILT_USER_ROLE_BASE_POLICY_ARN
              Value: !Ref 'ManagedUserRoleBasePolicy'
            - Name: QUILT_WEB_HOST
              Value: !Ref 'QuiltWebHost'
            - Name: QUILT_USER_ATHENA_DATABASE
              Value: !Ref 'UserAthenaDatabase'
            - Name: QUILT_USER_ATHENA_RESULTS_BUCKET
              Value: !Ref 'UserAthenaResultsBucket'
            - Name: QUILT_USER_ATHENA_BYTES_SCANNED_CUTOFF
              Value: !Ref 'UserAthenaBytesScannedCutoff'
            - Name: QUILT_TABULATOR_REGISTRY_HOST
              Value: !Sub 'registry.${AWS::StackName}:8080'
            - Name: QUILT_TABULATOR_KMS_KEY_ID
              Value: !GetAtt 'TabulatorKMSKey.Arn'
            - Name: QUILT_TABULATOR_SPILL_BUCKET
              Value: !Ref 'TabulatorBucket'
            - Name: QUILT_TABULATOR_OPEN_QUERY_ROLE
              Value: !Ref 'TabulatorOpenQueryRole'
            - Name: QUILT_TABULATOR_ENABLED
              Value: '1'
            - Name: QUILT_S3_EVENTBRIDGE_QUEUE_URL
              Value: !Ref 'S3SNSToEventBridgeQueue'
            - Name: QUILT_ICEBERG_GLUE_DB
              Value: !Ref 'IcebergDatabase'
            - Name: QUILT_ICEBERG_BUCKET
              Value: !Ref 'IcebergBucket'
            - Name: QUILT_ICEBERG_WORKGROUP
              Value: !Ref 'IcebergWorkGroup'
            - Name: QUILT_INDEXER_QUEUE_URL
              Value: !Ref 'IndexerQueue'
            - Name: ANALYTICS_DATABASE
              Value:
                - _
                -   - '-'
                    - !Ref 'AnalyticsBucket'
            - Name: QUILT_ANALYTICS_BUCKET
              Value: !Ref 'AnalyticsBucket'
            - Name: AZURE_BASE_URL
              Value: !Ref 'AzureBaseUrl'
            - Name: AZURE_CLIENT_ID
              Value: !Ref 'AzureClientId'
            - Name: AZURE_CLIENT_SECRET
              Value: !Ref 'AzureClientSecret'
            - Name: DISABLE_PASSWORD_AUTH
              Value:
                - SingleSignOn
                - '1'
                - ''
            - Name: DISABLE_PASSWORD_SIGNUP
              Value: '1'
            - Name: GOOGLE_CLIENT_ID
              Value: !Ref 'GoogleClientId'
            - Name: GOOGLE_CLIENT_SECRET
              Value: !Ref 'GoogleClientSecret'
            - Name: GOOGLE_DOMAIN_WHITELIST
              Value: !Ref 'SingleSignOnDomains'
            - Name: OKTA_BASE_URL
              Value: !Ref 'OktaBaseUrl'
            - Name: OKTA_CLIENT_ID
              Value: !Ref 'OktaClientId'
            - Name: OKTA_CLIENT_SECRET
              Value: !Ref 'OktaClientSecret'
            - Name: ONELOGIN_BASE_URL
              Value: !Ref 'OneLoginBaseUrl'
            - Name: ONELOGIN_CLIENT_ID
              Value: !Ref 'OneLoginClientId'
            - Name: ONELOGIN_CLIENT_SECRET
              Value: !Ref 'OneLoginClientSecret'
            - Name: SSO_PROVIDERS
              Value:
                - ' '
                -   -   - GoogleAuth
                        - google
                        - ''
                    -   - OktaAuth
                        - okta
                        - ''
                    -   - OneLoginAuth
                        - onelogin
                        - ''
                    -   - AzureAuth
                        - azure
                        - ''
            - Name: QUILT_SERVICE_AUTH_KEY
              Value: !Ref 'ServiceAuthKey'
            - Name: QUILT_STATUS_REPORTS_BUCKET
              Value: !Ref 'StatusReportsBucket'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: registry
          ReadonlyRootFilesystem: true
          LinuxParameters:
            InitProcessEnabled: true
          SystemControls:
            - Namespace: net.ipv4.tcp_keepalive_time
              Value: '150'
            - Namespace: net.ipv4.tcp_keepalive_intvl
              Value: '25'
            - Namespace: net.ipv4.tcp_keepalive_probes
              Value: '3'
          MountPoints:
            - SourceVolume: registry-tmp
              ContainerPath: /tmp/
            - SourceVolume: registry-managed-agents
              ContainerPath: /managed-agents
            - SourceVolume: registry-var-lib-amazon-ssm
              ContainerPath: /var/lib/amazon/ssm
            - SourceVolume: registry-var-log-amazon-ssm
              ContainerPath: /var/log/amazon/ssm
          DependsOn:
            - ContainerName: registry-tmp-volume-chmod
              Condition: SUCCESS
        - Name: nginx
          Image:
            - ${AccountId}.dkr.ecr.${Region}.amazonaws.com/quiltdata/nginx:${Tag}
            - AccountId:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - AccountId
              Region:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - PrimaryRegion
              Tag: ac7f8faffa5164d569ceea83de971831ccc36a59
          Environment:
            - Name: UWSGI_HOST
              Value: localhost
            - Name: UWSGI_PORT
              Value: '9000'
            - Name: REGISTRY_TABULATOR_PORT
              Value: '8080'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: registry
          ReadonlyRootFilesystem: true
          PortMappings:
            - ContainerPort: 80
          LinuxParameters:
            InitProcessEnabled: true
          MountPoints:
            - SourceVolume: nginx-tmp
              ContainerPath: /tmp/
            - SourceVolume: nginx-var-lib-nginx-tmp
              ContainerPath: /var/lib/nginx/tmp/
            - SourceVolume: nginx-run
              ContainerPath: /run/
            - SourceVolume: nginx-managed-agents
              ContainerPath: /managed-agents
            - SourceVolume: nginx-var-lib-amazon-ssm
              ContainerPath: /var/lib/amazon/ssm
            - SourceVolume: nginx-var-log-amazon-ssm
              ContainerPath: /var/log/amazon/ssm
      Volumes:
        - Name: nginx-tmp
        - Name: nginx-var-lib-nginx-tmp
        - Name: nginx-run
        - Name: nginx-managed-agents
        - Name: nginx-var-lib-amazon-ssm
        - Name: nginx-var-log-amazon-ssm
        - Name: registry-tmp
        - Name: registry-managed-agents
        - Name: registry-var-lib-amazon-ssm
        - Name: registry-var-log-amazon-ssm
    Type: AWS::ECS::TaskDefinition
  BulkScannerTaskDefinition:
    Properties:
      Family: !Sub '${AWS::StackName}-bulk-scanner'
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      ExecutionRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      TaskRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      Cpu: '512'
      Memory: 2GB
      ContainerDefinitions:
        - Name: bucket_scanner
          Image:
            - ${AccountId}.dkr.ecr.${Region}.amazonaws.com/quiltdata/registry:${Tag}
            - AccountId:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - AccountId
              Region:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - PrimaryRegion
              Tag: b58572ae7e5126222c7ac306eee022ed2f05450c
          Environment:
            - Name: AWS_DEFAULT_REGION
              Value: !Ref 'AWS::Region'
            - Name: CATALOG_URL
              Value: !Sub 'https://${QuiltWebHost}'
            - Name: GIT_HASH
              Value: vb58572ae7e5126222c7ac306eee022ed2f05450c
            - Name: QUILT_LOG_LEVEL
              Value: INFO
            - Name: QUILT_MANAGED_USER_ROLE_ARN
              Value: !Ref 'ManagedUserRole'
            - Name: QUILT_READ_ROLE_ARN
              Value: !Ref 'T4BucketReadRole'
            - Name: QUILT_QPE_ROLE_ARN
              Value: !Ref 'PackagerRole'
            - Name: QUILT_SERVER_CONFIG
              Value: prod_config.py
            - Name: QUILT_WRITE_ROLE_ARN
              Value: !Ref 'T4BucketWriteRole'
            - Name: SQLALCHEMY_DATABASE_URI
              Value: !Ref 'DBUrl'
            - Name: QUILT_QPE_RO_CRATE_RULE_ARN
              Value: !GetAtt 'PackagerROCrateRule.Arn'
            - Name: QUILT_QPE_OMICS_RULE_ARN
              Value: !GetAtt 'PackagerOmicsRule.Arn'
            - Name: QUILT_BULK_SCANNER_MAX_PAGES
              Value: '20'
            - Name: CHUNK_LIMIT_BYTES
              Value: '99000000'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: bulk_loader
          ReadonlyRootFilesystem: true
          Command:
            - flask
            - bucket_scanner
            - !GetAtt 'IndexerQueue.QueueName'
    Type: AWS::ECS::TaskDefinition
  RegistryMigrationTaskDefinition:
    Properties:
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      ExecutionRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      TaskRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      Cpu: '512'
      Memory: 2GB
      ContainerDefinitions:
        - Name: registry_migration
          Image:
            - ${AccountId}.dkr.ecr.${Region}.amazonaws.com/quiltdata/registry:${Tag}
            - AccountId:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - AccountId
              Region:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - PrimaryRegion
              Tag: b58572ae7e5126222c7ac306eee022ed2f05450c
          Environment:
            - Name: AWS_DEFAULT_REGION
              Value: !Ref 'AWS::Region'
            - Name: CATALOG_URL
              Value: !Sub 'https://${QuiltWebHost}'
            - Name: GIT_HASH
              Value: vb58572ae7e5126222c7ac306eee022ed2f05450c
            - Name: QUILT_LOG_LEVEL
              Value: INFO
            - Name: QUILT_MANAGED_USER_ROLE_ARN
              Value: !Ref 'ManagedUserRole'
            - Name: QUILT_READ_ROLE_ARN
              Value: !Ref 'T4BucketReadRole'
            - Name: QUILT_QPE_ROLE_ARN
              Value: !Ref 'PackagerRole'
            - Name: QUILT_SERVER_CONFIG
              Value: prod_config.py
            - Name: QUILT_WRITE_ROLE_ARN
              Value: !Ref 'T4BucketWriteRole'
            - Name: SQLALCHEMY_DATABASE_URI
              Value: !Ref 'DBUrl'
            - Name: QUILT_QPE_RO_CRATE_RULE_ARN
              Value: !GetAtt 'PackagerROCrateRule.Arn'
            - Name: QUILT_QPE_OMICS_RULE_ARN
              Value: !GetAtt 'PackagerOmicsRule.Arn'
            - Name: ALLOW_ANONYMOUS_ACCESS
              Value: ''
            - Name: ANALYTICS_CATALOG_ID
              Value: !Ref 'AWS::AccountId'
            - Name: AWS_MP_METERING
              Value: hourly
            - Name: AWS_MP_PRODUCT_CODE
              Value: f5d6l3y7x2yy2fcm0uxr9gglh
            - Name: AWS_MP_PUBLIC_KEY_VERSION
              Value: '1'
            - Name: AWS_STACK_ID
              Value: !Ref 'AWS::StackId'
            - Name: CUSTOMER_ID
              Value: ''
            - Name: DEPLOYMENT_ID
              Value: !Ref 'QuiltWebHost'
            - Name: EMAIL_SERVER
              Value: https://email.quiltdata.com
            - Name: ES_ENDPOINT
              Value:
                - https://${ES_HOST}
                - ES_HOST: !Ref 'SearchDomainEndpoint'
            - Name: MIXPANEL_PROJECT_TOKEN
              Value: e3385877c980efdce0a7eaec5a8a8277
            - Name: QUILT_ADMIN_EMAIL
              Value: !Ref 'AdminEmail'
            - Name: QUILT_ADMIN_PASSWORD
              Value:
                - SsoAuth
                - ''
                - !Ref 'AdminPassword'
            - Name: QUILT_ADMIN_SSO_ONLY
              Value:
                - SsoAuth
                - '1'
                - ''
            - Name: QUILT_ASSUME_ROLE_POLICY_ARN
              Value: !Ref 'RegistryAssumeRolePolicy'
            - Name: QUILT_AUDIT_TRAIL_DELIVERY_STREAM
              Value: !Ref 'AuditTrailDeliveryStream'
            - Name: QUILT_BUCKET_READ_POLICY_ARN
              Value: !Ref 'BucketReadPolicy'
            - Name: QUILT_BUCKET_WRITE_POLICY_ARN
              Value: !Ref 'BucketWritePolicy'
            - Name: QUILT_IAM_PATH
              Value: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
            - Name: QUILT_IAM_POLICY_NAME_PREFIX
              Value: Quilt-
            - Name: QUILT_INDEXER_LAMBDA_ARN
              Value: !GetAtt 'SearchHandler.Arn'
            - Name: QUILT_INDEXING_BUCKET_CONFIGS_PARAMETER
              Value: !Ref 'IndexingPerBucketConfigs'
            - Name: QUILT_INDEXING_CONTENT_BYTES
              Value: '{"default": 1000000, "min": 0, "max": 1048576}'
            - Name: QUILT_INDEXING_CONTENT_EXTENSIONS
              Value: '[".csv", ".fcs", ".html", ".ipynb", ".json", ".md", ".parquet", ".pdf", ".pptx", ".rmd", ".rst", ".tab", ".tsv", ".txt", ".xls", ".xlsx"]'
            - Name: QUILT_PKG_CREATE_LAMBDA_ARN
              Value: !Ref 'PkgCreate'
            - Name: QUILT_PKG_EVENTS_QUEUE_URL
              Value: !Ref 'PkgEventsQueue'
            - Name: QUILT_PKG_PROMOTE_LAMBDA_ARN
              Value: !Ref 'PkgPromote'
            - Name: QUILT_DUCKDB_SELECT_LAMBDA_ARN
              Value: !Ref 'DuckDBSelectLambda'
            - Name: QUILT_SEARCH_MAX_DOCS_PER_SHARD
              Value: '10000'
            - Name: QUILT_SECURE_SEARCH
              Value: ''
            - Name: QUILT_SERVICE_BUCKET
              Value: !Ref 'ServiceBucket'
            - Name: QUILT_SNS_KMS_ID
              Value: !Ref 'SNSKMSKey'
            - Name: QUILT_STACK_NAME
              Value: !Ref 'AWS::StackName'
            - Name: QUILT_USER_ROLE_BASE_POLICY_ARN
              Value: !Ref 'ManagedUserRoleBasePolicy'
            - Name: QUILT_WEB_HOST
              Value: !Ref 'QuiltWebHost'
            - Name: QUILT_USER_ATHENA_DATABASE
              Value: !Ref 'UserAthenaDatabase'
            - Name: QUILT_USER_ATHENA_RESULTS_BUCKET
              Value: !Ref 'UserAthenaResultsBucket'
            - Name: QUILT_USER_ATHENA_BYTES_SCANNED_CUTOFF
              Value: !Ref 'UserAthenaBytesScannedCutoff'
            - Name: QUILT_TABULATOR_REGISTRY_HOST
              Value: !Sub 'registry.${AWS::StackName}:8080'
            - Name: QUILT_TABULATOR_KMS_KEY_ID
              Value: !GetAtt 'TabulatorKMSKey.Arn'
            - Name: QUILT_TABULATOR_SPILL_BUCKET
              Value: !Ref 'TabulatorBucket'
            - Name: QUILT_TABULATOR_OPEN_QUERY_ROLE
              Value: !Ref 'TabulatorOpenQueryRole'
            - Name: QUILT_TABULATOR_ENABLED
              Value: '1'
            - Name: QUILT_S3_EVENTBRIDGE_QUEUE_URL
              Value: !Ref 'S3SNSToEventBridgeQueue'
            - Name: QUILT_ICEBERG_GLUE_DB
              Value: !Ref 'IcebergDatabase'
            - Name: QUILT_ICEBERG_BUCKET
              Value: !Ref 'IcebergBucket'
            - Name: QUILT_ICEBERG_WORKGROUP
              Value: !Ref 'IcebergWorkGroup'
            - Name: QUILT_INDEXER_QUEUE_URL
              Value: !Ref 'IndexerQueue'
            - Name: ANALYTICS_DATABASE
              Value:
                - _
                -   - '-'
                    - !Ref 'AnalyticsBucket'
            - Name: QUILT_ANALYTICS_BUCKET
              Value: !Ref 'AnalyticsBucket'
            - Name: AZURE_BASE_URL
              Value: !Ref 'AzureBaseUrl'
            - Name: AZURE_CLIENT_ID
              Value: !Ref 'AzureClientId'
            - Name: AZURE_CLIENT_SECRET
              Value: !Ref 'AzureClientSecret'
            - Name: DISABLE_PASSWORD_AUTH
              Value:
                - SingleSignOn
                - '1'
                - ''
            - Name: DISABLE_PASSWORD_SIGNUP
              Value: '1'
            - Name: GOOGLE_CLIENT_ID
              Value: !Ref 'GoogleClientId'
            - Name: GOOGLE_CLIENT_SECRET
              Value: !Ref 'GoogleClientSecret'
            - Name: GOOGLE_DOMAIN_WHITELIST
              Value: !Ref 'SingleSignOnDomains'
            - Name: OKTA_BASE_URL
              Value: !Ref 'OktaBaseUrl'
            - Name: OKTA_CLIENT_ID
              Value: !Ref 'OktaClientId'
            - Name: OKTA_CLIENT_SECRET
              Value: !Ref 'OktaClientSecret'
            - Name: ONELOGIN_BASE_URL
              Value: !Ref 'OneLoginBaseUrl'
            - Name: ONELOGIN_CLIENT_ID
              Value: !Ref 'OneLoginClientId'
            - Name: ONELOGIN_CLIENT_SECRET
              Value: !Ref 'OneLoginClientSecret'
            - Name: SSO_PROVIDERS
              Value:
                - ' '
                -   -   - GoogleAuth
                        - google
                        - ''
                    -   - OktaAuth
                        - okta
                        - ''
                    -   - OneLoginAuth
                        - onelogin
                        - ''
                    -   - AzureAuth
                        - azure
                        - ''
            - Name: QUILT_SERVICE_AUTH_KEY
              Value: !Ref 'ServiceAuthKey'
            - Name: QUILT_STATUS_REPORTS_BUCKET
              Value: !Ref 'StatusReportsBucket'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: registry
          ReadonlyRootFilesystem: true
          Command:
            - sh
            - -c
            - !Sub 'flask db upgrade && ./scripts/create_roles.py -n ReadQuiltBucket -a ${T4BucketReadRole.Arn} && ./scripts/create_roles.py -n ReadWriteQuiltBucket -a ${T4BucketWriteRole.Arn} --default && ./scripts/create_admin.py -e -r ReadWriteQuiltBucket && ./scripts/update_bucket_resources.py && ./scripts/update_sns_kms.py && ./scripts/setup_role_athena_resources.py && ./scripts/setup_canaries.py ''${CanaryBucketAllowed}'' ''${CanaryBucketRestricted}'''
      Family: !Sub '${AWS::StackName}-registry-migration'
    Type: AWS::ECS::TaskDefinition
  S3ProxyTaskDefinition:
    Properties:
      Family: !Sub '${AWS::StackName}-s3-proxy'
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      ExecutionRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      TaskRoleArn: !Ref 'S3ProxyRole'
      Cpu: '256'
      Memory: 1GB
      ContainerDefinitions:
        - Name: s3-proxy
          Image:
            - ${AccountId}.dkr.ecr.${Region}.amazonaws.com/quiltdata/s3-proxy:${Tag}
            - AccountId:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - AccountId
              Region:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - PrimaryRegion
              Tag: c44e937c15aa500cf032d205fff424df8179c962
          Environment:
            - Name: INTERNAL_REGISTRY_URL
              Value: !Sub 'http://registry.${AWS::StackName}'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: s3-proxy
          ReadonlyRootFilesystem: true
          PortMappings:
            - ContainerPort: 80
          MountPoints:
            - SourceVolume: nginx-tmp
              ContainerPath: /tmp/
            - SourceVolume: nginx-var-lib-nginx-tmp
              ContainerPath: /var/lib/nginx/tmp/
            - SourceVolume: nginx-run
              ContainerPath: /run/
      Volumes:
        - Name: nginx-tmp
        - Name: nginx-var-lib-nginx-tmp
        - Name: nginx-run
    Type: AWS::ECS::TaskDefinition
  MigrationLambdaFunctionLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/MigrationLambdaFunction'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  MigrationLambdaFunction:
    Properties:
      Handler: index.handler
      Role: !Ref 'MigrationLambdaRole'
      Code:
        ZipFile: |
          import json
          import time

          import boto3
          import cfnresponse

          DELAY_MS = 10000  # Wait 10s initially and before re-trying.
          MIN_TIME_MS = 10000  # Don't try if there's less than 10s remaining.
          ENV_VAR = "CLOUDFORMATION_REQUEST_TYPE"  # Injected env var name

          ecs = boto3.client("ecs")


          def handler(event, context):
              print("Received request:")
              print(json.dumps(event))

              params = event["ResourceProperties"]
              params.pop("ServiceToken", None)

              # persist the resource across stack updates
              id = event.get("PhysicalResourceId")

              def respond(status, reason=None):
                  return cfnresponse.send(event, context, status, None, id, reason=reason)

              # by default don't run the task on delete
              run_on_delete = params.pop("RunOnDelete", False)
              if event["RequestType"] == "Delete" and not run_on_delete:
                  print("Not running on delete")
                  return respond(cfnresponse.SUCCESS)

              # inject CLOUDFORMATION_REQUEST_TYPE env var into containerOverrides
              # with the current request type (lowercased) as a value
              container_overrides = params.get("overrides", {}).get("containerOverrides")
              if isinstance(container_overrides, list):
                  value = event["RequestType"].lower()
                  for override in container_overrides:
                      if "environment" not in override:
                          override["environment"] = []
                      # malformed, skip (will fail on ecs.run_task)
                      if not isinstance(override["environment"], list):
                          continue
                      override["environment"].append({"name": ENV_VAR, "value": value})

              print("Starting a task:")
              print(json.dumps(params))

              while True:
                  time.sleep(DELAY_MS / 1000)  # Convert milliseconds to seconds
                  try:
                      response = ecs.run_task(**params)
                  except Exception as e:
                      print("Error starting a task:", e)
                      remaining_ms = context.get_remaining_time_in_millis()
                      if remaining_ms >= DELAY_MS + MIN_TIME_MS:
                          print(f"Retrying; time remaining: {remaining_ms}ms")
                          continue

                      print(f"Giving up; time remaining: {remaining_ms}ms")
                      return respond(cfnresponse.FAILED, f"Error starting a task: {e}")

                  print("Started:")
                  print(json.dumps(response, default=str))
                  return respond(cfnresponse.SUCCESS)
      Timeout: 90
      Runtime: python3.11
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'MigrationLambdaFunctionLogGroup'
    Type: AWS::Lambda::Function
  MigrationCallout:
    Properties:
      ServiceToken: !GetAtt 'MigrationLambdaFunction.Arn'
      taskDefinition: !Ref 'RegistryMigrationTaskDefinition'
      cluster: !Ref 'Cluster'
      launchType: FARGATE
      networkConfiguration:
        awsvpcConfiguration:
          assignPublicIp: DISABLED
          securityGroups:
            - !Ref 'OutboundSecurityGroup'
            - !Ref 'DBAccessorSecurityGroup'
            - !Ref 'SearchClusterAccessorSecurityGroup'
          subnets: !Ref 'Subnets'
    Type: Custom::LambdaCallout
    DependsOn:
      - BucketReadPolicy
      - BucketWritePolicy
  RegistryAccessorSecurityGroup:
    Properties:
      GroupDescription: Accesses the registry service privately (bypassing the ELB)
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::SecurityGroup
  RegistrySecurityGroup:
    Properties:
      GroupDescription: For the registry service
      VpcId: !Ref 'VPC'
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref 'RegistryAccessorSecurityGroup'
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
      SecurityGroupEgress:
        - CidrIp: 127.0.0.1/32
          IpProtocol: '-1'
    Type: AWS::EC2::SecurityGroup
  RegistryAccessorSecurityGroupEgress:
    Properties:
      GroupId: !Ref 'RegistryAccessorSecurityGroup'
      DestinationSecurityGroupId: !Ref 'RegistrySecurityGroup'
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
    Type: AWS::EC2::SecurityGroupEgress
  RegistryTargetGroup:
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /healthcheck
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Port: 80
      Protocol: HTTP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref 'VPC'
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
  RegistryListenerRule:
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref 'RegistryTargetGroup'
      Conditions:
        - Field: host-header
          Values:
            -   - .
                -   -   - '-'
                        -   -   - 0
                                -   - .
                                    - !Ref 'QuiltWebHost'
                            - registry
                    -   - 1
                        -   - .
                            - !Ref 'QuiltWebHost'
                    -   - 2
                        -   - .
                            - !Ref 'QuiltWebHost'
      ListenerArn: !Ref 'Listener'
      Priority: 30
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
  RegistryDiscoveryService:
    Properties:
      Name: registry
      DnsConfig:
        RoutingPolicy: MULTIVALUE
        DnsRecords:
          - Type: A
            TTL: 60
          - Type: AAAA
            TTL: 60
          - Type: SRV
            TTL: 60
      NamespaceId: !Ref 'DnsNamespace'
    Type: AWS::ServiceDiscovery::Service
  RegistryService:
    Properties:
      Cluster: !Ref 'Cluster'
      LaunchType: FARGATE
      DesiredCount: 1
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      ServiceName: !Sub '${AWS::StackName}-registry'
      LoadBalancers:
        - ContainerName: nginx
          ContainerPort: 80
          TargetGroupArn: !Ref 'RegistryTargetGroup'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref 'OutboundSecurityGroup'
            - !Ref 'ElbTargetSecurityGroup'
            - !Ref 'DBAccessorSecurityGroup'
            - !Ref 'SearchClusterAccessorSecurityGroup'
            - !Ref 'RegistrySecurityGroup'
          Subnets: !Ref 'Subnets'
      TaskDefinition: !Ref 'RegistryTaskDefinition'
      EnableExecuteCommand: true
      ServiceRegistries:
        - RegistryArn: !GetAtt 'RegistryDiscoveryService.Arn'
          Port: 80
    Type: AWS::ECS::Service
    DependsOn:
      - MigrationCallout
      - RegistryListenerRule
  TrackingTaskDefinition:
    Properties:
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      ExecutionRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      TaskRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      Cpu: '512'
      Memory: 2GB
      ContainerDefinitions:
        - Name: stack_status
          Image:
            - ${AccountId}.dkr.ecr.${Region}.amazonaws.com/quiltdata/registry:${Tag}
            - AccountId:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - AccountId
              Region:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - PrimaryRegion
              Tag: b58572ae7e5126222c7ac306eee022ed2f05450c
          Environment:
            - Name: AWS_DEFAULT_REGION
              Value: !Ref 'AWS::Region'
            - Name: CATALOG_URL
              Value: !Sub 'https://${QuiltWebHost}'
            - Name: GIT_HASH
              Value: vb58572ae7e5126222c7ac306eee022ed2f05450c
            - Name: QUILT_LOG_LEVEL
              Value: INFO
            - Name: QUILT_MANAGED_USER_ROLE_ARN
              Value: !Ref 'ManagedUserRole'
            - Name: QUILT_READ_ROLE_ARN
              Value: !Ref 'T4BucketReadRole'
            - Name: QUILT_QPE_ROLE_ARN
              Value: !Ref 'PackagerRole'
            - Name: QUILT_SERVER_CONFIG
              Value: prod_config.py
            - Name: QUILT_WRITE_ROLE_ARN
              Value: !Ref 'T4BucketWriteRole'
            - Name: SQLALCHEMY_DATABASE_URI
              Value: !Ref 'DBUrl'
            - Name: QUILT_QPE_RO_CRATE_RULE_ARN
              Value: !GetAtt 'PackagerROCrateRule.Arn'
            - Name: QUILT_QPE_OMICS_RULE_ARN
              Value: !GetAtt 'PackagerOmicsRule.Arn'
            - Name: ALLOW_ANONYMOUS_ACCESS
              Value: ''
            - Name: ANALYTICS_CATALOG_ID
              Value: !Ref 'AWS::AccountId'
            - Name: AWS_MP_METERING
              Value: hourly
            - Name: AWS_MP_PRODUCT_CODE
              Value: f5d6l3y7x2yy2fcm0uxr9gglh
            - Name: AWS_MP_PUBLIC_KEY_VERSION
              Value: '1'
            - Name: AWS_STACK_ID
              Value: !Ref 'AWS::StackId'
            - Name: CUSTOMER_ID
              Value: ''
            - Name: DEPLOYMENT_ID
              Value: !Ref 'QuiltWebHost'
            - Name: EMAIL_SERVER
              Value: https://email.quiltdata.com
            - Name: ES_ENDPOINT
              Value:
                - https://${ES_HOST}
                - ES_HOST: !Ref 'SearchDomainEndpoint'
            - Name: MIXPANEL_PROJECT_TOKEN
              Value: e3385877c980efdce0a7eaec5a8a8277
            - Name: QUILT_ADMIN_EMAIL
              Value: !Ref 'AdminEmail'
            - Name: QUILT_ADMIN_PASSWORD
              Value:
                - SsoAuth
                - ''
                - !Ref 'AdminPassword'
            - Name: QUILT_ADMIN_SSO_ONLY
              Value:
                - SsoAuth
                - '1'
                - ''
            - Name: QUILT_ASSUME_ROLE_POLICY_ARN
              Value: !Ref 'RegistryAssumeRolePolicy'
            - Name: QUILT_AUDIT_TRAIL_DELIVERY_STREAM
              Value: !Ref 'AuditTrailDeliveryStream'
            - Name: QUILT_BUCKET_READ_POLICY_ARN
              Value: !Ref 'BucketReadPolicy'
            - Name: QUILT_BUCKET_WRITE_POLICY_ARN
              Value: !Ref 'BucketWritePolicy'
            - Name: QUILT_IAM_PATH
              Value: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
            - Name: QUILT_IAM_POLICY_NAME_PREFIX
              Value: Quilt-
            - Name: QUILT_INDEXER_LAMBDA_ARN
              Value: !GetAtt 'SearchHandler.Arn'
            - Name: QUILT_INDEXING_BUCKET_CONFIGS_PARAMETER
              Value: !Ref 'IndexingPerBucketConfigs'
            - Name: QUILT_INDEXING_CONTENT_BYTES
              Value: '{"default": 1000000, "min": 0, "max": 1048576}'
            - Name: QUILT_INDEXING_CONTENT_EXTENSIONS
              Value: '[".csv", ".fcs", ".html", ".ipynb", ".json", ".md", ".parquet", ".pdf", ".pptx", ".rmd", ".rst", ".tab", ".tsv", ".txt", ".xls", ".xlsx"]'
            - Name: QUILT_PKG_CREATE_LAMBDA_ARN
              Value: !Ref 'PkgCreate'
            - Name: QUILT_PKG_EVENTS_QUEUE_URL
              Value: !Ref 'PkgEventsQueue'
            - Name: QUILT_PKG_PROMOTE_LAMBDA_ARN
              Value: !Ref 'PkgPromote'
            - Name: QUILT_DUCKDB_SELECT_LAMBDA_ARN
              Value: !Ref 'DuckDBSelectLambda'
            - Name: QUILT_SEARCH_MAX_DOCS_PER_SHARD
              Value: '10000'
            - Name: QUILT_SECURE_SEARCH
              Value: ''
            - Name: QUILT_SERVICE_BUCKET
              Value: !Ref 'ServiceBucket'
            - Name: QUILT_SNS_KMS_ID
              Value: !Ref 'SNSKMSKey'
            - Name: QUILT_STACK_NAME
              Value: !Ref 'AWS::StackName'
            - Name: QUILT_USER_ROLE_BASE_POLICY_ARN
              Value: !Ref 'ManagedUserRoleBasePolicy'
            - Name: QUILT_WEB_HOST
              Value: !Ref 'QuiltWebHost'
            - Name: QUILT_USER_ATHENA_DATABASE
              Value: !Ref 'UserAthenaDatabase'
            - Name: QUILT_USER_ATHENA_RESULTS_BUCKET
              Value: !Ref 'UserAthenaResultsBucket'
            - Name: QUILT_USER_ATHENA_BYTES_SCANNED_CUTOFF
              Value: !Ref 'UserAthenaBytesScannedCutoff'
            - Name: QUILT_TABULATOR_REGISTRY_HOST
              Value: !Sub 'registry.${AWS::StackName}:8080'
            - Name: QUILT_TABULATOR_KMS_KEY_ID
              Value: !GetAtt 'TabulatorKMSKey.Arn'
            - Name: QUILT_TABULATOR_SPILL_BUCKET
              Value: !Ref 'TabulatorBucket'
            - Name: QUILT_TABULATOR_OPEN_QUERY_ROLE
              Value: !Ref 'TabulatorOpenQueryRole'
            - Name: QUILT_TABULATOR_ENABLED
              Value: '1'
            - Name: QUILT_S3_EVENTBRIDGE_QUEUE_URL
              Value: !Ref 'S3SNSToEventBridgeQueue'
            - Name: QUILT_ICEBERG_GLUE_DB
              Value: !Ref 'IcebergDatabase'
            - Name: QUILT_ICEBERG_BUCKET
              Value: !Ref 'IcebergBucket'
            - Name: QUILT_ICEBERG_WORKGROUP
              Value: !Ref 'IcebergWorkGroup'
            - Name: AZURE_BASE_URL
              Value: !Ref 'AzureBaseUrl'
            - Name: AZURE_CLIENT_ID
              Value: !Ref 'AzureClientId'
            - Name: AZURE_CLIENT_SECRET
              Value: !Ref 'AzureClientSecret'
            - Name: DISABLE_PASSWORD_AUTH
              Value:
                - SingleSignOn
                - '1'
                - ''
            - Name: DISABLE_PASSWORD_SIGNUP
              Value: '1'
            - Name: GOOGLE_CLIENT_ID
              Value: !Ref 'GoogleClientId'
            - Name: GOOGLE_CLIENT_SECRET
              Value: !Ref 'GoogleClientSecret'
            - Name: GOOGLE_DOMAIN_WHITELIST
              Value: !Ref 'SingleSignOnDomains'
            - Name: OKTA_BASE_URL
              Value: !Ref 'OktaBaseUrl'
            - Name: OKTA_CLIENT_ID
              Value: !Ref 'OktaClientId'
            - Name: OKTA_CLIENT_SECRET
              Value: !Ref 'OktaClientSecret'
            - Name: ONELOGIN_BASE_URL
              Value: !Ref 'OneLoginBaseUrl'
            - Name: ONELOGIN_CLIENT_ID
              Value: !Ref 'OneLoginClientId'
            - Name: ONELOGIN_CLIENT_SECRET
              Value: !Ref 'OneLoginClientSecret'
            - Name: SSO_PROVIDERS
              Value:
                - ' '
                -   -   - GoogleAuth
                        - google
                        - ''
                    -   - OktaAuth
                        - okta
                        - ''
                    -   - OneLoginAuth
                        - onelogin
                        - ''
                    -   - AzureAuth
                        - azure
                        - ''
            - Name: QUILT_SERVICE_AUTH_KEY
              Value: !Ref 'ServiceAuthKey'
            - Name: QUILT_STATUS_REPORTS_BUCKET
              Value: !Ref 'StatusReportsBucket'
            - Name: QUILT_CLIENT_COMPANY
              Value: QuiltDev
            - Name: TEMPLATE_BUILD_METADATA
              Value: >-
                {"git_revision": "e22c197ab89f3819088e2dd044a508a64f0eec5f", "git_tag": "1.64.2", "git_repository": "/home/runner/work/deployment/deployment", "make_time": "2025-11-14 09:26:21.154760",
                "variant": "stable"}
            - Name: TEMPLATE_ENVIRONMENT
              Value: >-
                {"constants": {"intercom": "eprutqnr", "mixpanel": "e3385877c980efdce0a7eaec5a8a8277", "sentryDSN": "https://cfde44007c3844aab3d1ee3f0ba53a1a@sentry.io/1410550", "emailServer": "https://email.quiltdata.com"},
                "elastic_search_config": {"InstanceCount": 2, "InstanceType": "m5.xlarge.elasticsearch", "DedicatedMasterEnabled": true, "DedicatedMasterCount": 3, "DedicatedMasterType": "m5.large.elasticsearch",
                "ZoneAwarenessEnabled": true, "PerNodeVolumeSize": 1024, "VolumeType": "gp2", "VolumeIops": null, "enable_logs": false, "vpc": true}, "options": {"mode": "PRODUCT", "search_terminate_after":
                10000, "public": false, "use_cloudfront": false, "elb_scheme": "internet-facing", "existing_trail": true, "existing_vpc": true, "network_version": "2.0", "lambdas_in_vpc": true, "api_gateway_in_vpc":
                false, "test_users_for_sts": ["arn:aws:iam::712023778557:user/kevin-staging", "arn:aws:iam::712023778557:user/ernest-staging", "arn:aws:iam::712023778557:user/nl0-staging", "arn:aws:iam::712023778557:user/sergey",
                "arn:aws:iam::712023778557:user/fiskus-staging"], "social_signin": false, "multi_sso": true, "no_download": false, "old_db": false, "db_instance_class": "db.t3.small", "db_multi_az": true,
                "marketplaceProductCode": "f5d6l3y7x2yy2fcm0uxr9gglh", "localhost": false, "license": "quilt", "license_key": "", "indexer_lambda_memory": 512, "indexer_lambda_concurrency": 80, "indexer_lambda_batch_size":
                100, "thumbnail_lambda_memory": 2048, "service_container_count": 1, "ecs_exec": true, "ecs_public_ip": false, "canary_prefix": "stabl-", "canary_emails": true, "canary_debug": false, "canary_unprotected":
                true, "secure_search": false, "existing_db": true, "existing_search": true, "audit_trail": true, "debug": false, "local_ecr": false, "client_company": "QuiltDev", "catalog_url": "stable.quilttest.com",
                "chunk_limit_bytes": 99000000}, "indexing.content": {"bytes": 1000000, "extensions": [".csv", ".fcs", ".html", ".ipynb", ".json", ".md", ".parquet", ".pdf", ".pptx", ".rmd", ".rst", ".tab",
                ".tsv", ".txt", ".xls", ".xlsx"], "skip_rows_extensions": []}, "versions": {"preview": "59d99940b5b22d6ef71fd74a4b6a7239bb00b0fc", "tabular_preview": "207546e5fbae466955781f22cf88101a78193367",
                "thumbnail": "cca6f494d3987f786f323327b5fc13b057a11433", "transcode": "207546e5fbae466955781f22cf88101a78193367", "iceberg": "dd4ad471c744773b21cbbe7c6c1d65cbbdc45558", "indexer": "b5192ec0bab975559ea8e9196ca1aff64ed81eec",
                "access_counts": "207546e5fbae466955781f22cf88101a78193367", "pkgevents": "207546e5fbae466955781f22cf88101a78193367", "pkgpush": "9e19d208a4e1899713fcae45ffce34de27b6dfc5", "s3hash": "c2ff6ba7309fe979c232207eaf9684fa59c278ac",
                "status_reports": "207546e5fbae466955781f22cf88101a78193367", "catalog": "734046cde985d7eab56708700b25f403236589c1", "nginx": "ac7f8faffa5164d569ceea83de971831ccc36a59", "registry": "b58572ae7e5126222c7ac306eee022ed2f05450c",
                "s3-proxy": "c44e937c15aa500cf032d205fff424df8179c962", "voila-0.2.10": "d5da4d225fdf2ae5354d7ea7ae997a0611f89bb8", "voila-0.5.8": "2ef2055804d0cb749dc4a153b2cc28b4cbc6412b", "canaries":
                "7fc9572a7c5f8ef47fedf5c8194192ec33395c9b", "tabulator": "17120cca3a55d556c54351ba9a5ef9b9d81318d3", "duckdb-select": "6b3baebf96616631ca3d61d83bcd39896f7d8119", "es_ingest": "a1e390d1b014f8cbebc18f61ad76860a0214bf6d",
                "manifest_indexer": "e0ae23a6e530b626d6fe0e1704a1c7361e33613f"}, "voila": {"enabled": true, "log_level": "WARN", "show_tracebacks": true, "content_security_policy_localhost": false, "instance_type":
                "t3.small"}, "canaries": {"*": true}, "waf": {"api": false, "enabled": true, "include": ".*", "exclude": "x^"}, "deployment": "tf", "__meta__": {"git_revision": "e22c197ab89f3819088e2dd044a508a64f0eec5f",
                "git_tag": "1.64.2", "git_repository": "/home/runner/work/deployment/deployment", "make_time": "2025-11-14 09:26:21.154760", "variant": "stable"}}
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: registry
          ReadonlyRootFilesystem: true
          Command:
            - sh
            - -c
            - ./scripts/stack_status.py $CLOUDFORMATION_REQUEST_TYPE
      Family: !Sub '${AWS::StackName}-stack-status'
    Type: AWS::ECS::TaskDefinition
  TrackingCallout:
    Properties:
      ServiceToken: !GetAtt 'MigrationLambdaFunction.Arn'
      RunOnDelete: true
      taskDefinition: !Ref 'TrackingTaskDefinition'
      overrides:
        containerOverrides:
          - name: stack_status
      cluster: !Ref 'Cluster'
      launchType: FARGATE
      networkConfiguration:
        awsvpcConfiguration:
          assignPublicIp: DISABLED
          securityGroups:
            - !Ref 'OutboundSecurityGroup'
            - !Ref 'DBAccessorSecurityGroup'
            - !Ref 'SearchClusterAccessorSecurityGroup'
          subnets: !Ref 'Subnets'
    Type: Custom::LambdaCallout
  TrackingCron:
    Properties:
      ScheduleExpression: rate(1 day)
      Targets:
        - Id: TrackingCallout
          Arn: !GetAtt 'Cluster.Arn'
          RoleArn: !Ref 'TrackingCronRole'
          EcsParameters:
            TaskDefinitionArn: !Ref 'TrackingTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                  - !Ref 'OutboundSecurityGroup'
                  - !Ref 'DBAccessorSecurityGroup'
                  - !Ref 'SearchClusterAccessorSecurityGroup'
                Subnets: !Ref 'Subnets'
          Input: '{"containerOverrides": [{"name": "stack_status"}]}'
    Type: AWS::Events::Rule
  S3ProxyTargetGroup:
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Port: 80
      Protocol: HTTP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref 'VPC'
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
  S3ProxyListenerRule:
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref 'S3ProxyTargetGroup'
      Conditions:
        - Field: host-header
          Values:
            -   - .
                -   -   - '-'
                        -   -   - 0
                                -   - .
                                    - !Ref 'QuiltWebHost'
                            - s3-proxy
                    -   - 1
                        -   - .
                            - !Ref 'QuiltWebHost'
                    -   - 2
                        -   - .
                            - !Ref 'QuiltWebHost'
      ListenerArn: !Ref 'Listener'
      Priority: 40
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
  S3ProxyService:
    Properties:
      Cluster: !Ref 'Cluster'
      LaunchType: FARGATE
      DesiredCount: 1
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      ServiceName: !Sub '${AWS::StackName}-s3-proxy'
      LoadBalancers:
        - ContainerName: s3-proxy
          ContainerPort: 80
          TargetGroupArn: !Ref 'S3ProxyTargetGroup'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref 'OutboundSecurityGroup'
            - !Ref 'ElbTargetSecurityGroup'
            - !Ref 'RegistryAccessorSecurityGroup'
          Subnets: !Ref 'Subnets'
      TaskDefinition: !Ref 'S3ProxyTaskDefinition'
    Type: AWS::ECS::Service
    DependsOn: S3ProxyListenerRule
  BulkScannerService:
    Properties:
      Cluster: !Ref 'Cluster'
      LaunchType: FARGATE
      DesiredCount: 1
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      ServiceName: !Sub '${AWS::StackName}-bulk-scanner'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref 'OutboundSecurityGroup'
            - !Ref 'DBAccessorSecurityGroup'
          Subnets: !Ref 'Subnets'
      TaskDefinition: !Ref 'BulkScannerTaskDefinition'
    Type: AWS::ECS::Service
    DependsOn:
      - MigrationCallout
  NginxCatalogTaskDefinition:
    Properties:
      Family: !Sub '${AWS::StackName}-nginx_catalog'
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      ExecutionRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      TaskRoleArn: !Ref 'AmazonECSTaskExecutionRole'
      Cpu: '256'
      Memory: '0.5GB'
      ContainerDefinitions:
        - Name: nginx-catalog
          Image:
            - ${AccountId}.dkr.ecr.${Region}.amazonaws.com/quiltdata/catalog:${Tag}
            - AccountId:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - AccountId
              Region:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - PrimaryRegion
              Tag: 734046cde985d7eab56708700b25f403236589c1
          Environment:
            - Name: REGION
              Value: !Ref 'AWS::Region'
            - Name: REGISTRY_URL
              Value:
                - https://${REG_URL}
                - REG_URL:
                    - .
                    -   -   - '-'
                            -   -   - 0
                                    -   - .
                                        - !Ref 'QuiltWebHost'
                                - registry
                        -   - 1
                            -   - .
                                - !Ref 'QuiltWebHost'
                        -   - 2
                            -   - .
                                - !Ref 'QuiltWebHost'
            - Name: API_GATEWAY
              Value: !Sub 'https://${Api}.execute-api.${AWS::Region}.amazonaws.com/prod'
            - Name: S3_PROXY_URL
              Value:
                - https://${PROXY_URL}
                - PROXY_URL:
                    - .
                    -   -   - '-'
                            -   -   - 0
                                    -   - .
                                        - !Ref 'QuiltWebHost'
                                - s3-proxy
                        -   - 1
                            -   - .
                                - !Ref 'QuiltWebHost'
                        -   - 2
                            -   - .
                                - !Ref 'QuiltWebHost'
            - Name: ALWAYS_REQUIRE_AUTH
              Value: 'true'
            - Name: INTERCOM_APP_ID
              Value: eprutqnr
            - Name: SENTRY_DSN
              Value: https://cfde44007c3844aab3d1ee3f0ba53a1a@sentry.io/1410550
            - Name: MIXPANEL_TOKEN
              Value: e3385877c980efdce0a7eaec5a8a8277
            - Name: ANALYTICS_BUCKET
              Value: !Ref 'AnalyticsBucket'
            - Name: SERVICE_BUCKET
              Value: !Ref 'ServiceBucket'
            - Name: CATALOG_MODE
              Value: PRODUCT
            - Name: NO_DOWNLOAD
              Value: 'false'
            - Name: CHUNKED_CHECKSUMS
              Value:
                - ChunkedChecksumsEnabled
                - 'true'
                - 'false'
            - Name: QURATOR
              Value:
                - QuratorEnabled
                - 'true'
                - 'false'
            - Name: STACK_VERSION
              Value: 1.64.2
            - Name: PACKAGE_ROOT
              Value: !Ref 'QuiltCatalogPackageRoot'
            - Name: PASSWORD_AUTH
              Value:
                - SingleSignOn
                - DISABLED
                - SIGN_IN_ONLY
            - Name: SSO_AUTH
              Value:
                - SsoAuth
                - ENABLED
                - DISABLED
            - Name: SSO_PROVIDERS
              Value:
                - ' '
                -   -   - GoogleAuth
                        - google
                        - ''
                    -   - OktaAuth
                        - okta
                        - ''
                    -   - OneLoginAuth
                        - onelogin
                        - ''
                    -   - AzureAuth
                        - azure
                        - ''
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: registry
          ReadonlyRootFilesystem: true
          PortMappings:
            - ContainerPort: 80
          MountPoints:
            - SourceVolume: nginx-tmp
              ContainerPath: /tmp/
            - SourceVolume: nginx-var-lib-nginx-tmp
              ContainerPath: /var/lib/nginx/tmp/
            - SourceVolume: nginx-run
              ContainerPath: /run/
      Volumes:
        - Name: nginx-tmp
        - Name: nginx-var-lib-nginx-tmp
        - Name: nginx-run
    Type: AWS::ECS::TaskDefinition
  NginxCatalogTargetGroup:
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /healthcheck
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Port: 80
      Protocol: HTTP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref 'VPC'
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
  CatalogListenerRule:
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref 'NginxCatalogTargetGroup'
      Conditions:
        - Field: host-header
          Values:
            - !Ref 'QuiltWebHost'
      ListenerArn: !Ref 'Listener'
      Priority: 25
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
  NginxCatalogService:
    Properties:
      Cluster: !Ref 'Cluster'
      LaunchType: FARGATE
      DesiredCount: 1
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      ServiceName: !Sub '${AWS::StackName}-nginx_catalog'
      LoadBalancers:
        - ContainerName: nginx-catalog
          ContainerPort: 80
          TargetGroupArn: !Ref 'NginxCatalogTargetGroup'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref 'OutboundSecurityGroup'
            - !Ref 'ElbTargetSecurityGroup'
          Subnets: !Ref 'Subnets'
      TaskDefinition: !Ref 'NginxCatalogTaskDefinition'
    Type: AWS::ECS::Service
    DependsOn: CatalogListenerRule
  Api:
    Properties:
      Name: !Ref 'AWS::StackName'
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: execute-api:Invoke
            Resource:
              - !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*/preview'
              - !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*/thumbnail'
              - !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*/tabular-preview'
              - !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*/transcode'
      MinimumCompressionSize: 1024
      BinaryMediaTypes:
        - '*/*'
      EndpointConfiguration:
        Types:
          -   - PartitionConfig
              - !Ref 'AWS::Partition'
              - ApiGatewayType
    Type: AWS::ApiGateway::RestApi
  PreviewHandlerLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/PreviewHandler'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  PreviewHandler:
    Properties:
      Handler: t4_lambda_preview.lambda_handler
      Role: !Ref 'ApiRole'
      Runtime: python3.11
      Timeout: 29
      MemorySize: 3008
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: preview/59d99940b5b22d6ef71fd74a4b6a7239bb00b0fc.zip
      Environment:
        Variables:
          WEB_ORIGIN: !Sub 'https://${QuiltWebHost}'
          JUPYTER_PATH: ./share/jupyter
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'PreviewHandlerLogGroup'
    Type: AWS::Lambda::Function
  PreviewResource:
    Properties:
      RestApiId: !Ref 'Api'
      ParentId: !GetAtt 'Api.RootResourceId'
      PathPart: preview
    Type: AWS::ApiGateway::Resource
  PreviewMethod:
    Properties:
      RestApiId: !Ref 'Api'
      ResourceId: !Ref 'PreviewResource'
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${PreviewHandler.Arn}/invocations'
    Type: AWS::ApiGateway::Method
  PreviewPermission:
    Properties:
      FunctionName: !GetAtt 'PreviewHandler.Arn'
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*/*/*'
    Type: AWS::Lambda::Permission
  ThumbnailLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/ThumbnailLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  ThumbnailLambda:
    Properties:
      Role: !Ref 'ApiRole'
      PackageType: Image
      Timeout: 29
      MemorySize: 2048
      Code:
        ImageUri:
          - ${AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/quiltdata/lambdas/thumbnail:cca6f494d3987f786f323327b5fc13b057a11433
          - AccountId:
              - GovCloud
              - !Ref 'AWS::AccountId'
              -   - PartitionConfig
                  - !Ref 'AWS::Partition'
                  - AccountId
      Environment:
        Variables:
          WEB_ORIGIN: !Sub 'https://${QuiltWebHost}'
          MAX_IMAGE_PIXELS: 2147483648
          CLEANUP_TMP_DIR: '1'
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'ThumbnailLambdaLogGroup'
    Type: AWS::Lambda::Function
  ThumbnailResource:
    Properties:
      RestApiId: !Ref 'Api'
      ParentId: !GetAtt 'Api.RootResourceId'
      PathPart: thumbnail
    Type: AWS::ApiGateway::Resource
  ThumbnailMethod:
    Properties:
      RestApiId: !Ref 'Api'
      ResourceId: !Ref 'ThumbnailResource'
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ThumbnailLambda.Arn}/invocations'
    Type: AWS::ApiGateway::Method
  ThumbnailPermission:
    Properties:
      FunctionName: !GetAtt 'ThumbnailLambda.Arn'
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*/*/*'
    Type: AWS::Lambda::Permission
  TranscodeFfmpegLayer:
    Properties:
      LayerName: ffmpeg
      Content:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: transcode/ffmpeg-4.4.1-amd64-static.zip
    Type: AWS::Lambda::LayerVersion
  TranscodeHandlerLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/TranscodeHandler'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  TranscodeHandler:
    Properties:
      Handler: index.lambda_handler
      Role: !Ref 'ApiRole'
      Runtime: python3.11
      Timeout: 29
      MemorySize: 2048
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: transcode/207546e5fbae466955781f22cf88101a78193367.zip
      Environment:
        Variables:
          WEB_ORIGIN: !Sub 'https://${QuiltWebHost}'
      Layers:
        - !Ref 'TranscodeFfmpegLayer'
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'TranscodeHandlerLogGroup'
    Type: AWS::Lambda::Function
  TranscodeResource:
    Properties:
      RestApiId: !Ref 'Api'
      ParentId: !GetAtt 'Api.RootResourceId'
      PathPart: transcode
    Type: AWS::ApiGateway::Resource
  TranscodeMethod:
    Properties:
      RestApiId: !Ref 'Api'
      ResourceId: !Ref 'TranscodeResource'
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TranscodeHandler.Arn}/invocations'
    Type: AWS::ApiGateway::Method
  TranscodePermission:
    Properties:
      FunctionName: !GetAtt 'TranscodeHandler.Arn'
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*/*/*'
    Type: AWS::Lambda::Permission
  TabularPreviewLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/TabularPreviewLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  TabularPreviewLambda:
    Properties:
      Handler: t4_lambda_tabular_preview.lambda_handler
      Role: !Ref 'ApiRole'
      Runtime: python3.11
      Timeout: 29
      MemorySize: 3008
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: tabular_preview/207546e5fbae466955781f22cf88101a78193367.zip
      Environment:
        Variables:
          WEB_ORIGIN: !Sub 'https://${QuiltWebHost}'
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'TabularPreviewLambdaLogGroup'
    Type: AWS::Lambda::Function
  TabularPreviewPermission:
    Properties:
      FunctionName: !GetAtt 'TabularPreviewLambda.Arn'
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${Api}/*/*/*'
    Type: AWS::Lambda::Permission
  TabularPreviewResource:
    Properties:
      RestApiId: !Ref 'Api'
      ParentId: !GetAtt 'Api.RootResourceId'
      PathPart: tabular-preview
    Type: AWS::ApiGateway::Resource
  TabularPreviewMethod:
    Properties:
      RestApiId: !Ref 'Api'
      ResourceId: !Ref 'TabularPreviewResource'
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TabularPreviewLambda.Arn}/invocations'
    Type: AWS::ApiGateway::Method
  ApiDeployment1763112382:
    Properties:
      RestApiId: !Ref 'Api'
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - PreviewMethod
      - ThumbnailMethod
      - TranscodeMethod
      - TabularPreviewMethod
  ApiStage:
    Properties:
      StageName: prod
      RestApiId: !Ref 'Api'
      DeploymentId: !Ref 'ApiDeployment1763112382'
    Type: AWS::ApiGateway::Stage
  ServiceBucket:
    Properties:
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: user-requests
            Status: Enabled
            Prefix: user-requests/
            ExpirationInDays: 1
            NoncurrentVersionExpirationInDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
    Type: AWS::S3::Bucket
  ServiceBucketPolicy:
    Properties:
      Bucket: !Ref 'ServiceBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'ServiceBucket.Arn'
              - !Sub '${ServiceBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
    Type: AWS::S3::BucketPolicy
  S3ObjectResourceHandlerRole:
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole'
    Type: AWS::IAM::Role
  S3ObjectResourceHandlerLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/S3ObjectResourceHandler'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  S3ObjectResourceHandler:
    Properties:
      Runtime: python3.11
      Code:
        ZipFile: |
          import base64
          import json
          from urllib.request import urlopen

          import boto3
          import cfnresponse

          s3 = boto3.client("s3")

          copy_args = {"MetadataDirective": "COPY", "TaggingDirective": "COPY"}


          def copy(src):
              return lambda **kwargs: s3.copy_object(**copy_args, **kwargs, CopySource=src)


          def put(body):
              return lambda **kwargs: s3.put_object(**kwargs, Body=body)


          def handler(event, context):
              print("Received request:", json.dumps(event, indent=4))

              req = event["RequestType"]
              props = event["ResourceProperties"]
              bucket = props.get("Bucket")
              key = props.get("Key")
              old_id = event.get("PhysicalResourceId")

              fail = lambda r: cfnresponse.send(event, context, cfnresponse.FAILED, None, reason=r)

              if not (bucket and key and set(props) & {"Body", "URL", "Base64Body", "Source"}):
                  return fail("Missing required parameters")

              try:
                  if req in ("Create", "Update"):
                      if "Source" in props:
                          op = copy(props["Source"])
                      elif "URL" in props:
                          with urlopen(props["URL"]) as f:
                              op = put(f.read())
                      elif "Base64Body" in props:
                          try:
                              op = put(base64.b64decode(props["Base64Body"], validate=True))
                          except Exception as e:
                              print("Base64Body decode error:", e)
                              return fail("Base64Body decode error")
                      else:
                          op = put(props["Body"])

                      if old_id and event.get("OldResourceProperties", {}).get("Versioning", False):
                          s3.delete_object(**json.loads(old_id))

                      res = op(Bucket=bucket, Key=key)
                      data = {"Bucket": bucket, "Key": key}
                      if props.get("Versioning", False):
                          data["VersionId"] = res["VersionId"]
                      id = json.dumps(data)
                      return cfnresponse.send(event, context, cfnresponse.SUCCESS, data, id)

                  if req == "Delete":
                      s3.delete_object(**json.loads(old_id))
                      return cfnresponse.send(event, context, cfnresponse.SUCCESS, None, old_id)

              except Exception as e:
                  print("Unhandled exception:", e)
                  return fail(f"Unhandled exception: {e}")

              return fail(f"Unexpected RequestType: {req}")
      Handler: index.handler
      Role: !GetAtt 'S3ObjectResourceHandlerRole.Arn'
      Timeout: 30
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'S3ObjectResourceHandlerLogGroup'
    Type: AWS::Lambda::Function
  TimestampResourceHandlerLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/TimestampResourceHandler'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  TimestampResourceHandler:
    Properties:
      Runtime: python3.11
      Code:
        ZipFile: |
          import datetime
          import json

          import cfnresponse


          def handler(event, context):
              print("Received request:", json.dumps(event, indent=4))

              req = event["RequestType"]
              props = event["ResourceProperties"]

              ts_iso = event.get("PhysicalResourceId")

              fail = lambda r: cfnresponse.send(event, context, cfnresponse.FAILED, None, reason=r)
              succeed = lambda data, id: cfnresponse.send(event, context, cfnresponse.SUCCESS, data, id)

              try:
                  if req in ("Create", "Update"):
                      if ts_iso:
                          ts = datetime.datetime.fromisoformat(ts_iso)
                      else:
                          ts = datetime.datetime.now(datetime.timezone.utc)
                          ts_iso = ts.isoformat()

                      fmt = props.get("Format")
                      formatted = ts.strftime(fmt) if fmt else ts_iso

                      data = {
                          "Timestamp": ts_iso,
                          "Format": fmt,
                          "Formatted": formatted,
                      }

                      return succeed(data, ts_iso)

                  if req == "Delete":
                      return succeed(None, ts_iso)

              except Exception as e:
                  print("Unhandled exception:", e)
                  return fail(f"Unhandled exception: {e}")

              return fail(f"Unexpected RequestType: {req}")
      Handler: index.handler
      Role: !Ref 'TimestampResourceHandlerRole'
      Timeout: 30
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'TimestampResourceHandlerLogGroup'
    Type: AWS::Lambda::Function
  VoilaTargetGroup:
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /voila/
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Port: 80
      Protocol: HTTP
      TargetType: instance
      UnhealthyThresholdCount: 2
      VpcId: !Ref 'VPC'
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: '0'
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
  VoilaListenerRule:
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref 'VoilaTargetGroup'
      Conditions:
        - Field: host-header
          Values:
            -   - .
                -   -   - '-'
                        -   -   - 0
                                -   - .
                                    - !Ref 'QuiltWebHost'
                            - registry
                    -   - 1
                        -   - .
                            - !Ref 'QuiltWebHost'
                    -   - 2
                        -   - .
                            - !Ref 'QuiltWebHost'
        - Field: path-pattern
          Values:
            - /voila/*
      ListenerArn: !Ref 'Listener'
      Priority: 26
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
  VoilaECSTaskRole:
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns: []
      Policies: []
    Type: AWS::IAM::Role
  VoilaTaskDefinition:
    Properties:
      Family: !Sub '${AWS::StackName}-voila'
      ContainerDefinitions:
        - Name: voila
          Image:
            - ${AccountId}.dkr.ecr.${Region}.amazonaws.com/quiltdata/voila:${Tag}
            - AccountId:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - AccountId
              Region:
                - PartitionConfig
                - !Ref 'AWS::Partition'
                - PrimaryRegion
              Tag:
                - VoilaImage
                - !Ref 'VoilaVersion'
                - Tag
          Command:
            - voila
            - --no-browser
            - --port=8866
            - --show_tracebacks=True
            - --Voila.log_level=WARN
            - --Voila.root_dir=.
            - --KernelManager.transport=ipc
            - --base_url=/voila/
            - !Sub '--Voila.tornado_settings={"headers":{"Content-Security-Policy":"frame-ancestors ''self'' ${QuiltWebHost}; object-src ''none''"}}'
            - --MappingKernelManager.cull_interval=60
            - --MappingKernelManager.cull_idle_timeout=120
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: voila
          Privileged: true
          ReadonlyRootFilesystem: true
          MemoryReservation: 512
        - Name: nginx-conf-init
          Essential: false
          Image: public.ecr.aws/nginx/nginx:1.24
          EntryPoint:
            - bash
            - -c
          Command:
            -   - echo ${conf_data} | base64 -d > /etc/nginx/conf.d/default.conf
                - conf_data: !Base64 "server {\n    server_tokens off;\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    client_max_body_size 75M;\n\n    gzip on;\n    gzip_min_length 1024;\n    gzip_types text/plain application/json;\n\n    location /voila/ {\n        proxy_pass http://localhost:8866;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_read_timeout 86400;\n\n        proxy_buffering off;\n\n        add_header 'Access-Control-Allow-Origin' '*' always;\n    }\n}\n"
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: voila
          ReadonlyRootFilesystem: true
          MountPoints:
            - ContainerPath: /etc/nginx/conf.d/
              SourceVolume: nginx-conf
          MemoryReservation: 64
        - Name: nginx
          Image: public.ecr.aws/nginx/nginx:1.24
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroup'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: voila
          DependsOn:
            - Condition: SUCCESS
              ContainerName: nginx-conf-init
          PortMappings:
            - ContainerPort: 80
          ReadonlyRootFilesystem: true
          MountPoints:
            - SourceVolume: nginx-var-cache-nginx
              ContainerPath: /var/cache/nginx/
            - SourceVolume: nginx-run
              ContainerPath: /run/
          VolumesFrom:
            - SourceContainer: nginx-conf-init
              ReadOnly: true
          MemoryReservation: 64
      Volumes:
        - Name: nginx-conf
        - Name: nginx-var-cache-nginx
        - Name: nginx-run
      NetworkMode: host
      RequiresCompatibilities:
        - EC2
      TaskRoleArn: !Ref 'VoilaECSTaskRole'
    Type: AWS::ECS::TaskDefinition
  VoilaECSInstanceRole:
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role'
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore'
    Type: AWS::IAM::Role
  VoilaAutoScalingGroupInstanceProfile:
    Properties:
      Roles:
        - !Ref 'VoilaECSInstanceRole'
    Type: AWS::IAM::InstanceProfile
  VoilaAutoScalingLaunchTemplate:
    Properties:
      LaunchTemplateData:
        IamInstanceProfile:
          Arn: !GetAtt 'VoilaAutoScalingGroupInstanceProfile.Arn'
        ImageId: !Ref 'VoilaAMI'
        InstanceType: t3.small
        CreditSpecification:
          CpuCredits: standard
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: false
            Groups:
              - !Ref 'OutboundSecurityGroup'
              - !Ref 'ElbTargetSecurityGroup'
        UserData:
          Fn::Sub: "#!/bin/bash -xe\necho ECS_CLUSTER=${Cluster} >> /etc/ecs/ecs.config\nyum update -y\nyum install -y aws-cfn-bootstrap\n/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource VoilaAutoScalingGroup --region ${AWS::Region}\n"
    Type: AWS::EC2::LaunchTemplate
  VoilaAutoScalingGroup:
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref 'VoilaAutoScalingLaunchTemplate'
        Version: !GetAtt 'VoilaAutoScalingLaunchTemplate.LatestVersionNumber'
      VPCZoneIdentifier: !Ref 'Subnets'
      MinSize: '1'
      MaxSize: '2'
      DesiredCapacity: '1'
    Type: AWS::AutoScaling::AutoScalingGroup
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1
        MinSuccessfulInstancesPercent: 100
        WaitOnResourceSignals: true
        PauseTime: PT15M
  VoilaService:
    Properties:
      Cluster: !Ref 'Cluster'
      LaunchType: EC2
      DesiredCount: 1
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      TaskDefinition: !Ref 'VoilaTaskDefinition'
      LoadBalancers:
        - ContainerName: nginx
          ContainerPort: 80
          TargetGroupArn: !Ref 'VoilaTargetGroup'
    Type: AWS::ECS::Service
    DependsOn:
      - VoilaAutoScalingGroup
      - VoilaListenerRule
  ServiceAuthKey:
    Properties:
      KeySpec: RSA_4096
      KeyUsage: SIGN_VERIFY
      KeyPolicy:
        Version: '2012-10-17'
        Id: key-service-auth
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:root'
            Action: kms:*
            Resource: '*'
          - Sid: Allow canaries signing JWTs to authenticate as service users in registry via OIDC-like flow
            Effect: Allow
            Principal:
              AWS: !Sub '${CloudWatchSyntheticsRole.Arn}'
            Action:
              - kms:DescribeKey
              - kms:Sign
            Resource: '*'
          - Sid: Allow registry to verify JWTs signed with this key to authenticate service users via OIDC-like flow
            Effect: Allow
            Principal:
              AWS: !Sub '${AmazonECSTaskExecutionRole.Arn}'
            Action:
              - kms:GetPublicKey
            Resource: '*'
    Type: AWS::KMS::Key
  CloudWatchSyntheticsRole:
    Properties:
      Path: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
      Description: !Sub 'CloudWatch Synthetics lambda execution role for running canaries in ${AWS::StackName} stack'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudWatchSyntheticsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: s3:PutObject
                Resource: !Sub '${SyntheticsResultsBucket.Arn}/*'
              - Effect: Allow
                Action: s3:GetBucketLocation
                Resource: !Sub '${SyntheticsResultsBucket.Arn}'
              - Effect: Allow
                Action: s3:ListAllMyBuckets
                Resource: '*'
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:CreateLogGroup
                Resource: !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/cwsyn-test-*'
              - Effect: Allow
                Action: cloudwatch:PutMetricData
                Resource: '*'
                Condition:
                  StringEquals:
                    cloudwatch:namespace: CloudWatchSynthetics
              - Effect: Allow
                Action: ec2:CreateNetworkInterface
                Resource: !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:network-interface/*'
              - Effect: Allow
                Action: ec2:CreateNetworkInterface
                Resource: !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:subnet/*'
                Condition:
                  ArnEquals:
                    ec2:Vpc: !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:vpc/${VPC}'
              - Effect: Allow
                Action: ec2:CreateNetworkInterface
                Resource: !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:security-group/*'
              - Effect: Allow
                Action: ec2:DeleteNetworkInterface
                Resource: '*'
                Condition:
                  ArnEqualsIfExists:
                    ec2:Vpc: !Sub 'arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:vpc/${VPC}'
              - Effect: Allow
                Action: ec2:DescribeNetworkInterfaces
                Resource: '*'
    Type: AWS::IAM::Role
  SyntheticsResultsBucket:
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
    Type: AWS::S3::Bucket
  SyntheticsResultsBucketPolicy:
    Properties:
      Bucket: !Ref 'SyntheticsResultsBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'SyntheticsResultsBucket.Arn'
              - !Sub '${SyntheticsResultsBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
    Type: AWS::S3::BucketPolicy
  CanaryBucketAllowed:
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      VersioningConfiguration:
        Status: Enabled
    Type: AWS::S3::Bucket
  CanaryBucketAllowedPolicy:
    Properties:
      Bucket: !Ref 'CanaryBucketAllowed'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'CanaryBucketAllowed.Arn'
              - !Sub '${CanaryBucketAllowed.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
          - Action:
              - s3:PutObject
              - s3:DeleteObject
              - s3:DeleteObjectVersion
            Effect: Allow
            Resource: !Sub 'arn:${AWS::Partition}:s3:::${CanaryBucketAllowed}/*'
            Principal:
              AWS: !Sub '${S3ObjectResourceHandlerRole.Arn}'
    Type: AWS::S3::BucketPolicy
  CanaryBucketAllowedReadme:
    Properties:
      ServiceToken: !Sub '${S3ObjectResourceHandler.Arn}'
      Bucket: !Ref 'CanaryBucketAllowed'
      Key: README.md
      Body: !Sub 'README for ${CanaryBucketAllowed} bucket'
      Versioning: true
    Type: Custom::S3Object
    DependsOn:
      - CanaryBucketAllowedPolicy
      - S3ObjectResourceHandlerLogGroup
  CanaryBucketAllowedCatalogConfig:
    Properties:
      ServiceToken: !Sub '${S3ObjectResourceHandler.Arn}'
      Bucket: !Ref 'CanaryBucketAllowed'
      Key: .quilt/catalog/config.yaml
      Body: !Sub "ui:\n  actions:\n    deleteRevision: True\n  sourceBuckets:\n    s3://${CanaryBucketAllowed}: {}"
      Versioning: true
    Type: Custom::S3Object
    DependsOn:
      - CanaryBucketAllowedPolicy
      - S3ObjectResourceHandlerLogGroup
  CanaryBucketAllowedWorkflowsConfig:
    Properties:
      ServiceToken: !Sub '${S3ObjectResourceHandler.Arn}'
      Bucket: !Ref 'CanaryBucketAllowed'
      Key: .quilt/workflows/config.yml
      Body: !Sub "version:\n  base: \"1\"\n  catalog: \"1\"\nis_workflow_required: false\nworkflows:\n  dummy:\n    name: Dummy\n  entries-meta:\n    name: Entries meta\n    entries_schema: entries-meta\nsuccessors:\n  s3://${CanaryBucketAllowed}:\n    title: self\nschemas:\n  entries-meta:\n    url: s3://${CanaryBucketAllowed}/.quilt/workflows/entries-meta.json"
      Versioning: true
    Type: Custom::S3Object
    DependsOn:
      - CanaryBucketAllowedPolicy
      - S3ObjectResourceHandlerLogGroup
  CanaryBucketAllowedEntriesMetaSchema:
    Properties:
      ServiceToken: !Sub '${S3ObjectResourceHandler.Arn}'
      Bucket: !Ref 'CanaryBucketAllowed'
      Key: .quilt/workflows/entries-meta.json
      Body: |-
        {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "type": "array",
          "contains": {
            "type": "object",
            "properties": {
              "logical_key": {
                "type": "string",
                "pattern": "^README\\.md"
              },
              "meta": {
                "type": "object",
                "properties": {
                  "foo": {
                    "type": "string",
                    "pattern": "^bar$"
                  }
                },
                "required": ["foo"]
              }
            }
          }
        }
      Versioning: true
    Type: Custom::S3Object
    DependsOn:
      - CanaryBucketAllowedPolicy
      - S3ObjectResourceHandlerLogGroup
  CanaryBucketRestricted:
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      VersioningConfiguration:
        Status: Enabled
    Type: AWS::S3::Bucket
  CanaryBucketRestrictedPolicy:
    Properties:
      Bucket: !Ref 'CanaryBucketRestricted'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'CanaryBucketRestricted.Arn'
              - !Sub '${CanaryBucketRestricted.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
          - Action:
              - s3:PutObject
              - s3:DeleteObject
              - s3:DeleteObjectVersion
            Effect: Allow
            Resource: !Sub 'arn:${AWS::Partition}:s3:::${CanaryBucketRestricted}/*'
            Principal:
              AWS: !Sub '${S3ObjectResourceHandlerRole.Arn}'
    Type: AWS::S3::BucketPolicy
  CanaryBucketRestrictedReadme:
    Properties:
      ServiceToken: !Sub '${S3ObjectResourceHandler.Arn}'
      Bucket: !Ref 'CanaryBucketRestricted'
      Key: README.md
      Body: !Sub 'README for ${CanaryBucketRestricted} bucket'
      Versioning: true
    Type: Custom::S3Object
    DependsOn:
      - CanaryBucketRestrictedPolicy
      - S3ObjectResourceHandlerLogGroup
  CanaryCatalogBucketAccessControl:
    Properties:
      Name: stabl-ctlg-bucket-ac
      Code:
        Handler: CatalogBucketAccessControl.handler
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: canaries/7fc9572a7c5f8ef47fedf5c8194192ec33395c9b/CatalogBucketAccessControl.zip
      ArtifactS3Location:
        - ''
        -   - s3://
            - !Ref 'SyntheticsResultsBucket'
      ExecutionRoleArn: !GetAtt 'CloudWatchSyntheticsRole.Arn'
      FailureRetentionPeriod: 180
      ProvisionedResourceCleanup: AUTOMATIC
      RunConfig:
        TimeoutInSeconds: 180
        EnvironmentVariables:
          CATALOG_ROOT: !Sub 'https://${QuiltWebHost}'
          BUCKET_ALLOWED: !Ref 'CanaryBucketAllowed'
          BUCKET_RESTRICTED: !Ref 'CanaryBucketRestricted'
          SERVICE_AUTH_KEY: !Ref 'ServiceAuthKey'
          SERVICE_AUTH_ENDPOINT:
            - https://${RegistryHost}:443/api/service_login
            - RegistryHost:
                - .
                -   -   - '-'
                        -   -   - 0
                                -   - .
                                    - !Ref 'QuiltWebHost'
                            - registry
                    -   - 1
                        -   - .
                            - !Ref 'QuiltWebHost'
                    -   - 2
                        -   - .
                            - !Ref 'QuiltWebHost'
        MemoryInMB: 960
      RuntimeVersion:
        - '-'
        -   - syn-nodejs-puppeteer
            - '10.0'
      Schedule:
        Expression: rate(1 hour)
        DurationInSeconds: '0'
      StartCanaryAfterCreation: true
      SuccessRetentionPeriod: 90
      Tags:
        - Key: Description
          Value: Users can only access specifically allowed buckets
        - Key: Group
          Value: Catalog
        - Key: Title
          Value: Bucket access control
      VPCConfig: !Ref 'AWS::NoValue'
    Type: AWS::Synthetics::Canary
    DependsOn:
      - RegistryService
      - CanaryBucketAllowedReadme
      - CanaryBucketAllowedCatalogConfig
      - CanaryBucketAllowedWorkflowsConfig
      - CanaryBucketRestrictedReadme
  CanaryCatalogImmutableUris:
    Properties:
      Name: stabl-ctlg-uri
      Code:
        Handler: CatalogImmutableUris.handler
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: canaries/7fc9572a7c5f8ef47fedf5c8194192ec33395c9b/CatalogImmutableUris.zip
      ArtifactS3Location:
        - ''
        -   - s3://
            - !Ref 'SyntheticsResultsBucket'
      ExecutionRoleArn: !GetAtt 'CloudWatchSyntheticsRole.Arn'
      FailureRetentionPeriod: 180
      ProvisionedResourceCleanup: AUTOMATIC
      RunConfig:
        TimeoutInSeconds: 180
        EnvironmentVariables:
          CATALOG_ROOT: !Sub 'https://${QuiltWebHost}'
          BUCKET_ALLOWED: !Ref 'CanaryBucketAllowed'
          BUCKET_RESTRICTED: !Ref 'CanaryBucketRestricted'
          SERVICE_AUTH_KEY: !Ref 'ServiceAuthKey'
          SERVICE_AUTH_ENDPOINT:
            - https://${RegistryHost}:443/api/service_login
            - RegistryHost:
                - .
                -   -   - '-'
                        -   -   - 0
                                -   - .
                                    - !Ref 'QuiltWebHost'
                            - registry
                    -   - 1
                        -   - .
                            - !Ref 'QuiltWebHost'
                    -   - 2
                        -   - .
                            - !Ref 'QuiltWebHost'
        MemoryInMB: 960
      RuntimeVersion:
        - '-'
        -   - syn-nodejs-puppeteer
            - '10.0'
      Schedule:
        Expression: rate(1 hour)
        DurationInSeconds: '0'
      StartCanaryAfterCreation: true
      SuccessRetentionPeriod: 90
      Tags:
        - Key: Description
          Value: Resolve immutable Quilt URIs
        - Key: Group
          Value: Catalog
        - Key: Title
          Value: Resolve Quilt URIs
      VPCConfig: !Ref 'AWS::NoValue'
    Type: AWS::Synthetics::Canary
    DependsOn:
      - RegistryService
  CanaryCatalogPackagePushUi:
    Properties:
      Name: stabl-ctlg-pkg-create
      Code:
        Handler: CatalogPackagePushUi.handler
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: canaries/7fc9572a7c5f8ef47fedf5c8194192ec33395c9b/CatalogPackagePushUi.zip
      ArtifactS3Location:
        - ''
        -   - s3://
            - !Ref 'SyntheticsResultsBucket'
      ExecutionRoleArn: !GetAtt 'CloudWatchSyntheticsRole.Arn'
      FailureRetentionPeriod: 180
      ProvisionedResourceCleanup: AUTOMATIC
      RunConfig:
        TimeoutInSeconds: 180
        EnvironmentVariables:
          CATALOG_ROOT: !Sub 'https://${QuiltWebHost}'
          BUCKET_ALLOWED: !Ref 'CanaryBucketAllowed'
          BUCKET_RESTRICTED: !Ref 'CanaryBucketRestricted'
          SERVICE_AUTH_KEY: !Ref 'ServiceAuthKey'
          SERVICE_AUTH_ENDPOINT:
            - https://${RegistryHost}:443/api/service_login
            - RegistryHost:
                - .
                -   -   - '-'
                        -   -   - 0
                                -   - .
                                    - !Ref 'QuiltWebHost'
                            - registry
                    -   - 1
                        -   - .
                            - !Ref 'QuiltWebHost'
                    -   - 2
                        -   - .
                            - !Ref 'QuiltWebHost'
        MemoryInMB: 960
      RuntimeVersion:
        - '-'
        -   - syn-nodejs-puppeteer
            - '10.0'
      Schedule:
        Expression: rate(1 hour)
        DurationInSeconds: '0'
      StartCanaryAfterCreation: true
      SuccessRetentionPeriod: 90
      Tags:
        - Key: Description
          Value: Push packages via Catalog package creation dialog
        - Key: Group
          Value: Catalog
        - Key: Title
          Value: Push packages via Catalog UI
      VPCConfig: !Ref 'AWS::NoValue'
    Type: AWS::Synthetics::Canary
    DependsOn:
      - RegistryService
      - CanaryBucketAllowedReadme
      - CanaryBucketAllowedCatalogConfig
      - CanaryBucketAllowedWorkflowsConfig
      - CanaryBucketRestrictedReadme
  CanaryCatalogSearch:
    Properties:
      Name: stabl-ctlg-search
      Code:
        Handler: CatalogSearch.handler
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: canaries/7fc9572a7c5f8ef47fedf5c8194192ec33395c9b/CatalogSearch.zip
      ArtifactS3Location:
        - ''
        -   - s3://
            - !Ref 'SyntheticsResultsBucket'
      ExecutionRoleArn: !GetAtt 'CloudWatchSyntheticsRole.Arn'
      FailureRetentionPeriod: 180
      ProvisionedResourceCleanup: AUTOMATIC
      RunConfig:
        TimeoutInSeconds: 180
        EnvironmentVariables:
          CATALOG_ROOT: !Sub 'https://${QuiltWebHost}'
          BUCKET_ALLOWED: !Ref 'CanaryBucketAllowed'
          BUCKET_RESTRICTED: !Ref 'CanaryBucketRestricted'
          SERVICE_AUTH_KEY: !Ref 'ServiceAuthKey'
          SERVICE_AUTH_ENDPOINT:
            - https://${RegistryHost}:443/api/service_login
            - RegistryHost:
                - .
                -   -   - '-'
                        -   -   - 0
                                -   - .
                                    - !Ref 'QuiltWebHost'
                            - registry
                    -   - 1
                        -   - .
                            - !Ref 'QuiltWebHost'
                    -   - 2
                        -   - .
                            - !Ref 'QuiltWebHost'
        MemoryInMB: 960
      RuntimeVersion:
        - '-'
        -   - syn-nodejs-puppeteer
            - '10.0'
      Schedule:
        Expression: rate(1 hour)
        DurationInSeconds: '0'
      StartCanaryAfterCreation: true
      SuccessRetentionPeriod: 90
      Tags:
        - Key: Description
          Value: Search S3 objects and Quilt packages in Catalog
        - Key: Group
          Value: Catalog
        - Key: Title
          Value: Search
      VPCConfig: !Ref 'AWS::NoValue'
    Type: AWS::Synthetics::Canary
    DependsOn:
      - RegistryService
      - CanaryBucketAllowedReadme
      - CanaryBucketAllowedCatalogConfig
      - CanaryBucketAllowedWorkflowsConfig
      - CanaryBucketRestrictedReadme
  CanaryNotificationsTopic:
    Properties:
      Subscription:
        - Protocol: email
          Endpoint: !Ref 'CanaryNotificationsEmail'
      KmsMasterKeyId: !Ref 'SNSKMSKey'
    Type: AWS::SNS::Topic
  CanaryErrorStateEventsRule:
    Properties:
      EventPattern:
        detail-type:
          - Synthetics Canary Status Change
        source:
          - aws.synthetics
        detail:
          canary-name:
            - stabl-ctlg-bucket-ac
            - stabl-ctlg-uri
            - stabl-ctlg-pkg-create
            - stabl-ctlg-search
          current-state:
            - ERROR
      Targets:
        - Id: NotificationsTopic
          Arn: !Ref 'CanaryNotificationsTopic'
    Type: AWS::Events::Rule
  CanaryFailureEventsRule:
    Properties:
      EventPattern:
        detail-type:
          - Synthetics Canary TestRun Failure
        source:
          - aws.synthetics
        detail:
          canary-name:
            - stabl-ctlg-bucket-ac
            - stabl-ctlg-uri
            - stabl-ctlg-pkg-create
            - stabl-ctlg-search
          test-run-status:
            - FAILED
      Targets:
        - Id: NotificationsTopic
          Arn: !Ref 'CanaryNotificationsTopic'
    Type: AWS::Events::Rule
  CanaryNotificationsTopicPolicy:
    Properties:
      Topics:
        - !Ref 'CanaryNotificationsTopic'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sns:Publish
            Resource: !Ref 'CanaryNotificationsTopic'
            Condition:
              ArnEquals:
                aws:SourceArn:
                  - !GetAtt 'CanaryErrorStateEventsRule.Arn'
                  - !GetAtt 'CanaryFailureEventsRule.Arn'
    Type: AWS::SNS::TopicPolicy
  StatusReportsBucket:
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
    Type: AWS::S3::Bucket
  StatusReportsBucketPolicy:
    Properties:
      Bucket: !Ref 'StatusReportsBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'StatusReportsBucket.Arn'
              - !Sub '${StatusReportsBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
    Type: AWS::S3::BucketPolicy
  StatusReportsRole:
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Sid: ''
          Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole'
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: s3:PutObject
                Resource: !Sub '${StatusReportsBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - cloudformation:ListStackResources
                  - cloudformation:DescribeStacks
                Resource: !Ref 'AWS::StackId'
              - Effect: Allow
                Action:
                  - synthetics:DescribeCanaries
                  - synthetics:DescribeCanariesLastRun
                Resource: '*'
                Condition:
                  ForAnyValue:StringEquals:
                    synthetics:Names:
                      - stabl-ctlg-bucket-ac
                      - stabl-ctlg-uri
                      - stabl-ctlg-pkg-create
                      - stabl-ctlg-search
              - Effect: Allow
                Action:
                  - synthetics:GetCanaryRuns
                Resource:
                  - !Sub 'arn:${AWS::Partition}:synthetics:${AWS::Region}:${AWS::AccountId}:canary:stabl-ctlg-bucket-ac'
                  - !Sub 'arn:${AWS::Partition}:synthetics:${AWS::Region}:${AWS::AccountId}:canary:stabl-ctlg-uri'
                  - !Sub 'arn:${AWS::Partition}:synthetics:${AWS::Region}:${AWS::AccountId}:canary:stabl-ctlg-pkg-create'
                  - !Sub 'arn:${AWS::Partition}:synthetics:${AWS::Region}:${AWS::AccountId}:canary:stabl-ctlg-search'
              - Effect: Allow
                Action:
                  - cloudwatch:GetMetricData
                Resource: '*'
    Type: AWS::IAM::Role
  StatusReportsLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/StatusReportsLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  StatusReportsLambda:
    Properties:
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: status_reports/207546e5fbae466955781f22cf88101a78193367.zip
      Handler: t4_lambda_status_reports.lambda_handler
      Role: !GetAtt 'StatusReportsRole.Arn'
      Runtime: python3.11
      Timeout: 900
      Environment:
        Variables:
          STACK_NAME: !Sub '${AWS::StackName}'
          STATUS_REPORTS_BUCKET: !Ref 'StatusReportsBucket'
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'StatusReportsLambdaLogGroup'
    Type: AWS::Lambda::Function
  StatusReportsCron:
    Properties:
      ScheduleExpression: cron(10 * * * ? *)
      Targets:
        - Arn: !GetAtt 'StatusReportsLambda.Arn'
          Id: StatusReports
    Type: AWS::Events::Rule
  StatusReportsPermission:
    Properties:
      FunctionName: !GetAtt 'StatusReportsLambda.Arn'
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt 'StatusReportsCron.Arn'
    Type: AWS::Lambda::Permission
  AuditTrailTimestamp:
    Properties:
      ServiceToken: !Sub '${TimestampResourceHandler.Arn}'
      Format: '%Y/%m/%d'
    Type: Custom::Timestamp
    DependsOn:
      - TimestampResourceHandlerLogGroup
  AuditTrailBucket:
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      VersioningConfiguration:
        Status: Enabled
    Type: AWS::S3::Bucket
  AuditTrailBucketPolicy:
    Properties:
      Bucket: !Ref 'AuditTrailBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'AuditTrailBucket.Arn'
              - !Sub '${AuditTrailBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
    Type: AWS::S3::BucketPolicy
  AuditTrailDatabase:
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseInput: {}
    Type: AWS::Glue::Database
  AuditTrailTable:
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseName: !Ref 'AuditTrailDatabase'
      TableInput:
        Name: audit_trail
        StorageDescriptor:
          Location: !Sub 's3://${AuditTrailBucket}/audit_trail/'
          Columns:
            - Name: eventVersion
              Type: string
            - Name: eventTime
              Type: timestamp
            - Name: eventID
              Type: string
            - Name: eventSource
              Type: string
            - Name: eventType
              Type: string
            - Name: eventName
              Type: string
            - Name: userAgent
              Type: string
            - Name: sourceIPAddress
              Type: string
            - Name: userIdentity
              Type: string
            - Name: requestParameters
              Type: string
            - Name: responseElements
              Type: string
            - Name: errorCode
              Type: string
            - Name: errorMessage
              Type: string
            - Name: additionalEventData
              Type: string
            - Name: requestID
              Type: string
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          Compressed: true
        PartitionKeys:
          - Name: date
            Type: string
        TableType: EXTERNAL_TABLE
        Parameters:
          projection.enabled: 'true'
          projection.date.type: date
          projection.date.format: yyyy/MM/dd
          projection.date.range: !Sub '${AuditTrailTimestamp.Formatted},NOW'
          projection.date.interval: '1'
          projection.date.interval.unit: DAYS
          storage.location.template: !Sub 's3://${AuditTrailBucket}/audit_trail/${!date}/'
    Type: AWS::Glue::Table
  AuditTrailWorkgroup:
    Properties:
      Name: !Sub '${AWS::StackName}-audit'
      WorkGroupConfiguration:
        ResultConfiguration:
          OutputLocation: !Sub 's3://${AuditTrailBucket}/athena_query_results/'
    Type: AWS::Athena::WorkGroup
  AuditTrailDeliveryLogStream:
    Properties:
      LogGroupName: !Ref 'LogGroup'
      LogStreamName: audit-trail/s3-delivery
    Type: AWS::Logs::LogStream
  AuditTrailDeliveryRole:
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: firehose.amazonaws.com
            Action: sts:AssumeRole
      Path: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
      Policies:
        - PolicyName: firehose_delivery_policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:AbortMultipartUpload
                  - s3:GetBucketLocation
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:ListBucketMultipartUploads
                  - s3:PutObject
                Resource:
                  - !Sub '${AuditTrailBucket.Arn}'
                  - !Sub '${AuditTrailBucket.Arn}/audit_trail/*'
                  - !Sub '${AuditTrailBucket.Arn}/audit_trail_errors/*'
    Type: AWS::IAM::Role
  AuditTrailDeliveryStream:
    Properties:
      DeliveryStreamEncryptionConfigurationInput:
        KeyType: AWS_OWNED_CMK
      ExtendedS3DestinationConfiguration:
        RoleARN: !GetAtt 'AuditTrailDeliveryRole.Arn'
        BucketARN: !GetAtt 'AuditTrailBucket.Arn'
        BufferingHints:
          IntervalInSeconds: 900
          SizeInMBs: 128
        CloudWatchLoggingOptions:
          Enabled: true
          LogGroupName: !Ref 'LogGroup'
          LogStreamName: !Ref 'AuditTrailDeliveryLogStream'
        CompressionFormat: GZIP
        DynamicPartitioningConfiguration:
          Enabled: true
        Prefix: audit_trail/!{partitionKeyFromQuery:date}/
        ErrorOutputPrefix: audit_trail_errors/!{timestamp:yyyy/MM/dd}/!{firehose:error-output-type}-
        ProcessingConfiguration:
          Enabled: true
          Processors:
            - Type: MetadataExtraction
              Parameters:
                - ParameterName: JsonParsingEngine
                  ParameterValue: JQ-1.6
                - ParameterName: MetadataExtractionQuery
                  ParameterValue: '{date: .eventTime | fromdate | strftime("%Y/%m/%d")}'
            - Type: AppendDelimiterToRecord
              Parameters:
                - ParameterName: Delimiter
                  ParameterValue: \n
    Type: AWS::KinesisFirehose::DeliveryStream
  AuditTrailAthenaQueryPolicy:
    Properties:
      Path: !Sub '/quilt/${AWS::StackName}/${AWS::Region}/'
      Description: Allow querying Audit Trail data via Athena
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AccessGlueCatalogAndDb
            Effect: Allow
            Action:
              - glue:GetDatabase
              - glue:GetDatabases
              - glue:GetTable
              - glue:GetTables
            Resource:
              - !Sub 'arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:catalog'
              - !Sub 'arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:database/${AuditTrailDatabase}'
              - !Sub 'arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:table/${AuditTrailDatabase}/*'
          - Sid: AccessAthenaResources
            Effect: Allow
            Action:
              - athena:ListEngineVersions
              - athena:ListWorkGroups
            Resource: '*'
          - Sid: AccessAthenaWorkgroup
            Effect: Allow
            Action:
              - athena:GetWorkGroup
              - athena:BatchGetQueryExecution
              - athena:GetQueryExecution
              - athena:ListQueryExecutions
              - athena:StartQueryExecution
              - athena:StopQueryExecution
              - athena:GetQueryResults
              - athena:GetQueryResultsStream
              - athena:CreateNamedQuery
              - athena:GetNamedQuery
              - athena:BatchGetNamedQuery
              - athena:ListNamedQueries
              - athena:DeleteNamedQuery
              - athena:CreatePreparedStatement
              - athena:GetPreparedStatement
              - athena:ListPreparedStatements
              - athena:UpdatePreparedStatement
              - athena:DeletePreparedStatement
              - athena:GetQueryRuntimeStatistics
            Resource:
              - !Sub 'arn:${AWS::Partition}:athena:${AWS::Region}:${AWS::AccountId}:workgroup/${AuditTrailWorkgroup}'
          - Sid: StoreQueryResults
            Effect: Allow
            Action:
              - s3:AbortMultipartUpload
              - s3:ListMultipartUploadParts
              - s3:PutObject
            Resource:
              - !Sub 'arn:${AWS::Partition}:s3:::${AuditTrailBucket}/athena_query_results/*'
            Condition:
              ForAnyValue:StringEquals:
                aws:CalledVia:
                  - athena.amazonaws.com
          - Sid: ReadS3Data
            Effect: Allow
            Action:
              - s3:GetBucketLocation
              - s3:GetObject
              - s3:ListBucket
            Resource:
              - !Sub 'arn:${AWS::Partition}:s3:::${AuditTrailBucket}'
              - !Sub 'arn:${AWS::Partition}:s3:::${AuditTrailBucket}/*'
            Condition:
              ForAnyValue:StringEquals:
                aws:CalledVia:
                  - athena.amazonaws.com
    Type: AWS::IAM::ManagedPolicy
  SNSKMSKey:
    Properties:
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:root'
            Action: kms:*
            Resource: '*'
          - Effect: Allow
            Principal:
              Service:
                - s3.amazonaws.com
                - events.amazonaws.com
            Action:
              - kms:GenerateDataKey*
              - kms:Decrypt
            Resource: '*'
      Tags:
        - Key: QuiltStackId
          Value: !Ref 'AWS::StackId'
    Type: AWS::KMS::Key
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
  TabulatorKMSKey:
    Properties:
      KeySpec: RSA_4096
      KeyUsage: SIGN_VERIFY
      KeyPolicy:
        Version: '2012-10-17'
        Id: key-service-auth
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:root'
            Action: kms:*
            Resource: '*'
          - Sid: Allow tabulator to sign requests
            Effect: Allow
            Principal:
              AWS: !Sub '${TabulatorRole.Arn}'
            Action: kms:Sign
            Resource: '*'
          - Sid: Allow registry to verify tabulator requests
            Effect: Allow
            Principal:
              AWS: !Sub '${AmazonECSTaskExecutionRole.Arn}'
            Action: kms:Verify
            Resource: '*'
    Type: AWS::KMS::Key
  TabulatorBucket:
    Properties:
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: clean-asap
            Status: Enabled
            ExpirationInDays: 1
            NoncurrentVersionExpirationInDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
    Type: AWS::S3::Bucket
  TabulatorSecurityGroup:
    Properties:
      GroupDescription: Access registry internal port for tabulator API
      VpcId: !Ref 'VPC'
      SecurityGroupEgress:
        - DestinationSecurityGroupId: !Ref 'RegistrySecurityGroup'
          IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
    Type: AWS::EC2::SecurityGroup
  TabulatorRegistrySecurityGroupIngress:
    Properties:
      GroupId: !Ref 'RegistrySecurityGroup'
      SourceSecurityGroupId: !Ref 'TabulatorSecurityGroup'
      IpProtocol: tcp
      FromPort: 8080
      ToPort: 8080
    Type: AWS::EC2::SecurityGroupIngress
  TabulatorLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/TabulatorLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  TabulatorLambda:
    Properties:
      Role: !Ref 'TabulatorRole'
      PackageType: Image
      Timeout: 900
      MemorySize: 2048
      Code:
        ImageUri:
          - ${AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/quiltdata/lambdas/tabulator:17120cca3a55d556c54351ba9a5ef9b9d81318d3
          - AccountId:
              - GovCloud
              - !Ref 'AWS::AccountId'
              -   - PartitionConfig
                  - !Ref 'AWS::Partition'
                  - AccountId
      Environment:
        Variables:
          CACHE_BUCKET: !Ref 'TabulatorBucket'
          CACHE_PREFIX: cache/
          REGISTRY_ENDPOINT: !Sub 'http://registry.${AWS::StackName}:8080/tabulator/'
          QUILT_ATHENA_DB: !Ref 'UserAthenaDatabase'
          KMS_KEY_ID: !GetAtt 'TabulatorKMSKey.Arn'
          DATAFUSION_EXECUTION_BATCH_SIZE: '1024'
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'TabulatorSecurityGroup'
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'TabulatorLambdaLogGroup'
    Type: AWS::Lambda::Function
  TabulatorDataCatalog:
    Properties:
      Name: !Sub 'quilt-${AWS::StackName}-tabulator'
      Type: LAMBDA
      Parameters:
        function: !GetAtt 'TabulatorLambda.Arn'
    Type: AWS::Athena::DataCatalog
  TabulatorBucketPolicy:
    Properties:
      Bucket: !Ref 'TabulatorBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'TabulatorBucket.Arn'
              - !Sub '${TabulatorBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
          - Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !Sub '${TabulatorBucket.Arn}'
              - !Sub '${TabulatorBucket.Arn}/*'
            Condition:
              ForAllValues:StringNotEquals:
                aws:CalledVia:
                  - athena.amazonaws.com
                  - cloudformation.amazonaws.com
              ArnNotEquals:
                lambda:SourceFunctionArn: !GetAtt 'TabulatorLambda.Arn'
              StringNotEquals:
                aws:PrincipalArn:
                  - ','
                  -   - ${base_arns}${extra_arns}
                      - base_arns:
                          - ','
                          -   - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/access-analyzer.amazonaws.com/AWSServiceRoleForAccessAnalyzer'
                        extra_arns:
                          - S3BucketPolicyExcludeArnsFromDenyEmpty
                          - ''
                          -   - ',${param}'
                              - param:
                                  - ','
                                  - !Ref 'S3BucketPolicyExcludeArnsFromDeny'
          - Effect: Deny
            Principal: '*'
            Action: '*'
            Resource: !Sub '${TabulatorBucket.Arn}/cache/*'
            Condition:
              ArnNotEquals:
                lambda:SourceFunctionArn: !GetAtt 'TabulatorLambda.Arn'
              StringNotEquals:
                aws:PrincipalArn:
                  - ','
                  -   - ${base_arns}${extra_arns}
                      - base_arns:
                          - ','
                          -   - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/access-analyzer.amazonaws.com/AWSServiceRoleForAccessAnalyzer'
                        extra_arns:
                          - S3BucketPolicyExcludeArnsFromDenyEmpty
                          - ''
                          -   - ',${param}'
                              - param:
                                  - ','
                                  - !Ref 'S3BucketPolicyExcludeArnsFromDeny'
    Type: AWS::S3::BucketPolicy
  TabulatorOpenQueryWorkGroup:
    Properties:
      Name: !Sub 'QuiltTabulatorOpenQuery-${AWS::StackName}'
      Description: !Sub 'WorkGroup for accessing Tabulator tables in open query mode in Quilt stack ${AWS::StackName}'
      RecursiveDeleteOption: true
      WorkGroupConfiguration:
        EnforceWorkGroupConfiguration: true
        ResultConfiguration:
          ExpectedBucketOwner: !Ref 'AWS::AccountId'
          OutputLocation: !Sub 's3://${UserAthenaResultsBucket}/athena-results/non-managed-roles/'
    Type: AWS::Athena::WorkGroup
  IcebergDatabase:
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseInput: {}
    Type: AWS::Glue::Database
  IcebergBucket:
    Properties:
      LifecycleConfiguration:
        Rules:
          - Id: clean-mpu
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
    Type: AWS::S3::Bucket
  IcebergBucketPolicy:
    Properties:
      Bucket: !Ref 'IcebergBucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceSecureTransport
            Effect: Deny
            Principal: '*'
            Action: '*'
            Resource:
              - !GetAtt 'IcebergBucket.Arn'
              - !Sub '${IcebergBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'
    Type: AWS::S3::BucketPolicy
  IcebergWorkGroup:
    Properties:
      Name: !Sub '${AWS::StackName}-Iceberg'
      WorkGroupConfiguration:
        ManagedQueryResultsConfiguration:
          Enabled: true
      Description: !Sub 'Workgroup for Quilt stack ''${AWS::StackName}'' to manage iceberg tables'
      RecursiveDeleteOption: true
    Type: AWS::Athena::WorkGroup
  IcebergLambdaDeadLetterQueue:
    Type: AWS::SQS::Queue
  IcebergLambdaQueue:
    Properties:
      VisibilityTimeout: 360
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt 'IcebergLambdaDeadLetterQueue.Arn'
        maxReceiveCount: 20
      MessageRetentionPeriod: 345600
    Type: AWS::SQS::Queue
  IcebergLambdaRule:
    Properties:
      EventBusName: !GetAtt 'EventBus.Arn'
      EventPattern:
        source:
          - com.quiltdata.s3
        detail-type:
          - prefix: 'ObjectCreated:'
          - prefix: 'ObjectRemoved:'
        detail:
          eventSource:
            - aws:s3
          s3:
            object:
              key:
                - prefix: .quilt/named_packages/
                - prefix: .quilt/packages/
      Targets:
        - Arn: !GetAtt 'IcebergLambdaQueue.Arn'
          Id: IcebergLambdaQueue
    Type: AWS::Events::Rule
  IcebergLambdaQueuePolicy:
    Properties:
      Queues:
        - !Ref 'IcebergLambdaQueue'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt 'IcebergLambdaQueue.Arn'
            Condition:
              ArnEquals:
                aws:SourceArn: !GetAtt 'IcebergLambdaRule.Arn'
    Type: AWS::SQS::QueuePolicy
  IcebergLambdaLogGroup:
    Properties:
      LogGroupName: !Sub '/quilt/${AWS::StackName}/IcebergLambda'
      RetentionInDays: 90
    Type: AWS::Logs::LogGroup
  IcebergLambda:
    Properties:
      Runtime: python3.11
      Code:
        S3Bucket: !Sub 'quilt-lambda-${AWS::Region}'
        S3Key: iceberg/dd4ad471c744773b21cbbe7c6c1d65cbbdc45558.zip
      Handler: t4_lambda_iceberg.handler
      Role: !Ref 'IcebergLambdaRole'
      Timeout: 60
      MemorySize: 128
      ReservedConcurrentExecutions: 3
      Environment:
        Variables:
          QUILT_USER_ATHENA_DATABASE: !Ref 'UserAthenaDatabase'
          QUILT_ICEBERG_GLUE_DB: !Ref 'IcebergDatabase'
          QUILT_ICEBERG_BUCKET: !Ref 'IcebergBucket'
          QUILT_ICEBERG_WORKGROUP: !Ref 'IcebergWorkGroup'
      VpcConfig:
        SubnetIds: !Ref 'Subnets'
        SecurityGroupIds:
          - !Ref 'OutboundSecurityGroup'
      LoggingConfig:
        LogGroup: !Ref 'IcebergLambdaLogGroup'
    Type: AWS::Lambda::Function
  IcebergLambdaEventSourceMapping:
    Properties:
      EventSourceArn: !GetAtt 'IcebergLambdaQueue.Arn'
      FunctionName: !Ref 'IcebergLambda'
      Enabled: true
      BatchSize: 1
      MaximumBatchingWindowInSeconds: 0
    Type: AWS::Lambda::EventSourceMapping
